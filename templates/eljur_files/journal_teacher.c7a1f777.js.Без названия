var role_timeout=6e4,mtypes=[],current_input=null,Logger=void 0,isRating=!1,stlsn=void 0;window.disableSetAvg=!1,window.hometask_max_datetime=!1;var teacherConfig={markNa:'н/а',markDismissed:'осв',markDismissedOld:'ос'};function requestError(e){console.error(e);var t='Ошибка';if(window.trans)if(e&&e.status)switch(e.status){case 403:case 404:t=window.trans('error.session_expired');break;case 500:case 501:case 502:case 503:case 504:t=window.trans('error.request');break;default:t=window.trans('error.server_connect')}else t=window.trans('error.server_connect');alert(t)}var JournalTeacher={url:'/journal-index-rpc-teacher-action',mode:'journal',year:'',part:'',sp:'',lesson_id:'',lesson:'',cls:'',grp:'',setInf:function(e,t,r,a,n,o,s){this.year=e,this.lesson_id=t,this.lesson=r,this.cls=a,this.grp=n,this.part=o,this.sp=s},setJournalMark:function(e,t,r,a,n,o,s){n=n||!1,o=o||!1,s=s||!1,this.year=e,this.lesson_id=t,this.lesson=r,this.cls=a,!1!==o&&(this.part=o),!1!==n&&(this.grp=n),!1!==s&&(this.sp=s)},setGroup:function(e){this.grp=e},error:function(e,t){t=t||!1,(t=!0)&&alert(e,!0)},setBookLesson:function(e,t){jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.set_book_lesson',{lesson:e,book_lesson:t},JournalTeacher.url),(function(e){in_array(e.error,[void 0,''])||JournalTeacher.error(e.error)}))},setFipiLesson:function(e,t,r){var a=$('#fed_lessons').children('div[lesson_id="'+e+'"]').children('div.column-status'),n=a.children('.loading'),o=a.children('.done'),s=a.children('.error');o.addClass('hide').removeAttr('style'),s.addClass('hide'),n.removeClass('hide'),jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.set_fipi_lesson',{'class':t,lesson_id:e,catalog_id:r},JournalTeacher.url),(function(e){n.addClass('hide'),in_array(e.error,[void 0,''])?(o.removeClass('hide'),setTimeout((function(){o.fadeOut(200,(function(){$(this).addClass('hide').removeAttr('style')}))}),1500)):(JournalTeacher.error(e.error),s.removeClass('hide'))}))},notifyZavichSetFinalmark:function(e,t){jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.notify_zavich_set_final_mark',{year:this.year,part:e,lesson_id:this.lesson_id,username:t},JournalTeacher.url),(function(e){in_array(e.error,[void 0,''])||JournalTeacher.error(e.error)}))},CWAllowAll:function(e){jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.cw_allow_all',{value:e},JournalTeacher.url),(function(e){in_array(e.error,[void 0,''])||JournalTeacher.error(e.error)}))},CWAllowMonday:function(e){jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.cw_allow_monday',{value:e},JournalTeacher.url),(function(e){in_array(e.error,[void 0,''])||JournalTeacher.error(e.error)}))},setSystemPref:function(e,t,r){r=r||!1,jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.set_system_pref',{pref:e,value:t},JournalTeacher.url),(function(e){in_array(e.error,[void 0,''])?r&&r():JournalTeacher.error(e.error)}))},setSystemPrefByDeps:function(e,t,r){r=r||!1,jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.set_system_pref_by_deps',{pref:e,by_deps:t},JournalTeacher.url),(function(e){in_array(e.error,[void 0,''])?r&&r():JournalTeacher.error(e.error)}))},setTwoMarksLessons:function(e,t){t=t||!1,jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.set_two_marks_lessons',{lessonIds:e},JournalTeacher.url),(function(e){in_array(e.error,[void 0,''])?t&&t():JournalTeacher.error(e.error)}))},setHomeTaskRate:function(e,t,r){r=r||!1,jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.set_hometask_rate',{parallel:e,value:t},JournalTeacher.url),(function(e){in_array(e.error,[void 0,''])?r&&r():JournalTeacher.error(e.error)}))},addBlockSP:function(e,t,r){r=r||!1,jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.add_block_sp',{tid:e,pid:t},JournalTeacher.url),(function(e){in_array(e.error,[void 0,''])?r&&r():JournalTeacher.error(e.error)}))},removeBlockSP:function(e,t,r){r=r||!1,jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.remove_block_sp',{tid:e,pid:t},JournalTeacher.url),(function(e){in_array(e.error,[void 0,''])?r&&r():JournalTeacher.error(e.error)}))},CWSetRate:function(e,t,r,a){jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.cw_set_rate',{'class':e,grp:t,lesson_id:r,h:a},JournalTeacher.url),(function(e){in_array(e.error,[void 0,''])||JournalTeacher.error(e.error)}))},CWSetMax:function(e){jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.cw_set_max',{value:e},JournalTeacher.url),(function(e){in_array(e.error,[void 0,''])||JournalTeacher.error(e.error)}))},addTypeSet:function(e,t,r){jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.add_type_set',{name:e,weight:t,color:r},JournalTeacher.url),(function(e){if(in_array(e.error,[void 0,''])||JournalTeacher.error(e.error),e.result){var t=$('#sets > tbody:last > tr:not([set_id])');t.attr('set_id',e.tsid),t.find('button.remover').removeClass('hide'),t.find('button.saver').addClass('hide'),'undefined'!=typeof updateSchTypes&&updateSchTypes()}}))},modifyTypeSet:function(e,t,r,a){jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.modify_type_set',{id:e,name:t||!1,weight:r||!1,color:a||!1},JournalTeacher.url),(function(e){in_array(e.error,[void 0,''])||JournalTeacher.error(e.error),e.result&&'undefined'!=typeof updateSchTypes&&updateSchTypes()}))},removeTypeSet:function(e){jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.remove_type_set',{id:e},JournalTeacher.url),(function(e){in_array(e.error,[void 0,''])||JournalTeacher.error(e.error),e.result&&'undefined'!=typeof updateSchTypes&&updateSchTypes()}))},addCWLesson:function(e){jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.add_cw_lesson',{lesson_id:e},JournalTeacher.url),(function(e){in_array(e.error,[void 0,''])||JournalTeacher.error(e.error)}))},removeCWLesson:function(e){jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.remove_cw_lesson',{lesson_id:e},JournalTeacher.url),(function(e){in_array(e.error,[void 0,''])||JournalTeacher.error(e.error)}))},addCWClass:function(e){jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.add_cw_class',{'class':e},JournalTeacher.url),(function(e){in_array(e.error,[void 0,''])||JournalTeacher.error(e.error)}))},removeCWClass:function(e){jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.remove_cw_class',{'class':e},JournalTeacher.url),(function(e){in_array(e.error,[void 0,''])||JournalTeacher.error(e.error)}))},addControl:function(e,t,r,a){a||(a=this.lesson_id),jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.add_control',{'class':this.cls,grp:this.grp,cw_lesson_id:a,date:e,cw_type:t,cw_level:r},JournalTeacher.url),(function(e){in_array(e.error,[void 0,''])||JournalTeacher.error(e.error)}))},removeControl:function(e,t,r){t||(t=this.lesson_id),jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.remove_control',{'class':this.cls,grp:this.grp,date:e,cw_lesson_id:t},JournalTeacher.url),(function(e){in_array(e.error,[void 0,''])||JournalTeacher.error(e.error)}))},addCWHoliday:function(e,t){jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.add_cw_holiday',{name:t,date:e},JournalTeacher.url),(function(e){e.result}))},removeCWHoliday:function(e){jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.remove_cw_holiday',{date:e},JournalTeacher.url),(function(e){e.result}))},copyMarkTypes:function(e){jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.copy_mark_types',{lesson_id:this.lesson_id,'class':this.cls,grp:this.grp,ids:e},JournalTeacher.url),(function(e){in_array(e.error,[void 0,''])||JournalTeacher.error(e.error),document.location.reload(!0)}))},getLessonTopic:function(e,t,r,a){blockSubjectTextareaWithLoading(a.find('#subject')),jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.get_lesson_topic',{'year':this.year,'class':this.cls,'grp':this.grp,'lesson_id':this.lesson_id,'pid':e,'delta':t,'lesson_num':r},JournalTeacher.url),(function(e){if(e&&''==e.error&&''!=e.pid){a.find('#planr').prop('disabled',e.isLast),a.find('#planl').prop('disabled',e.isFirst),null!=e.topic&&null!=e.topic||(e.topic='');var r=unescape(e.topic),n=a.find('#subject');setPidOfLesson(e.pid,a),0===n.length?''!==a.find('td.tdTopic').text()&&0===t||a.find('td.tdTopic').text(r):(''!==n.val()&&0===t||n.val(r).attr('needsave','yes').trigger('blur').trigger('focus').removeClass('placeholder'),a.find('#subject').data('plan_topic',r)),0!=e.hometasks?(a.find('#setHomeTaskByPlan').prop('disabled',!1),planHometasks=e.hometasks):a.find('#setHomeTaskByPlan').prop('disabled',!0),a.find('#topicNumByPlan').removeClass('hidden'),a.find('#topicNumByPlan .plan_lesson_num').text(e.themeNum),initTopicCounter()}else a.find('#topicNumByPlan').addClass('hidden'),a.find('#planr, #planl').prop('disabled',!0),e&&!1===e.hasPlan&&(window.isSetPlanForGroup[JournalTeacher.grp]=!1);e&&''!==e.error&&alert(e.error),removeBlockSubjectTextarea(a.find('#subject'))}))},checkHometask:function(e,t){jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.check_hometask',{home_task_id:e},JournalTeacher.url),(function(e){if(''!==e.error)return JournalTeacher.error(e.error),!1;t()}))},removeHometask:function(e,t,r,a){null==r&&(r=0);var n=0;null!=window.journal_load_ids&&null!=journal_load_ids[this.grp]&&(n=journal_load_ids[this.grp]),jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.remove_hometask',{home_task_id:e,df:t,load_id:n,num:r},JournalTeacher.url),(function(e){if(!1===e.result&&''!==e.error)return JournalTeacher.error(e.error),!1;a()}))},updateHometaskComplaintComment:function(e,t,r){jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.update_hometask_complaint_comment',{complaint_id:e,comment:t},JournalTeacher.url),(function(e){if(!1===e.result&&''!==e.error)return JournalTeacher.error(e.error),!1;r()}))},getCommonTasksCurrent:function(){var e={};return $('tr.htedit').each((function(){var t={};t.id=this.id.substr(2),t.date=$(this).find('[name=htdate]').val(),t.text=$.trim($(this).find('input[name="task"]').val()),t.minutes=$(this).find('[name=htminutes]').val(),t.files=[],t.collect_files=$(this).find('[name=files_switch]').prop('checked'),t.collect_files_comment=$(this).find('[name=files_comment]').val(),$(this).parent().find('nobr[id!=0] > input:checked').each((function(e){var r=$(this.parentNode);t.files.push(r.attr('fid')?r.attr('fid'):r.attr('id').substr(4))})),t.resources=[],$(this).find('div.modal-resource-files label input:checked').each((function(){t.resources.push($(this).parent().data('id'))})),e[t.id]=t})),e},getEditedTasksIds:function(e,t){var r,a=[];return $.each(t,(function(n,o){r=!1,$.each(o,(function(a){switch(a){case'files':case'resources':if(e[n][a].length!==t[n][a].length)r=!0;else{var o='files'==a?'fid':'id';$.each(e[n][a],(function(e,s){if(-1==t[n][a].indexOf(s[o]))return r=!0,!1}))}if(r)return!1;break;default:if(e[n][a]!=t[n][a]&&(r=!0),r)return!1}})),r&&a.push(n)})),a},deleteAndSaveModalHometasks:function(e){var t=0;null!=window.journal_load_ids&&null!=journal_load_ids[this.grp]&&(t=journal_load_ids[this.grp]),e=JSON.stringify(e),jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.delete_and_save_modal_hometasks',{num:0,load_id:t,df:!0,home_task_ids:e},JournalTeacher.url),(function(e){if(!1===e.result&&''!==e.error)JournalTeacher.error(e.error);else{var t=$.trim($('#subject').val());t=t==$('#subject').attr('placeholder')?'':t;var r=[],a={},n='';$('tr.htnew').each((function(){var e=$.trim($(this).find('input[id^="ubel"]').val());r.push(e)})),$('tr.htedit').each((function(){var t=$(this).parents('#hometask').find('#pdate').val(),n=$(this).parents('#hometask').find('#pgrp').val(),o=$('#'+t+'N0_'+n+'_header'),s=$.trim($(this).find('input[id^="ubel"]').val());r.push(s);var l=this.id.substr(2),i=$('#ht'+l).find('input[name="task"]');i.removeAttr('name'),e.ids.indexOf(l)>-1&&(i.attr('name','task'),o.length>0&&(a=o))})),r.length>0&&(n=r.join(' ')),$('#showhtandthemetooltip').hasClass('active')&&a.length>0&&($(a).find('.fa-file').attr('tooltip_title',t).removeData('title').data('title',t).tooltip(),$(a).find('.fa-home').attr('tooltip_title',n).removeData('title').data('title',n).tooltip()),journalSetHometask($('#subject').parent().parent().parent())}}))},saveLessonHometask:function(e,t,r,a,n,o,s,l,i){null==i&&(i=0),0===a.length&&(a=!1),o=o||[],s=s||'',l=l||!1,rht=r,r=JSON.stringify(r),a=JSON.stringify(a),fast=$('#pgrp').length>0;var d=$('#g'+curgrp+'_homework > tr[lnum="'+e+'"] > td.tdHT');rht.length>2&&d.removeClass('saved notsave').addClass('saving');var c=0;null!=window.journal_load_ids&&null!=journal_load_ids[this.grp]&&(c=journal_load_ids[this.grp]),jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.save_lesson_hometask',{lesson_id:this.lesson_id,'class':this.cls,grp:this.grp,lesson_num:e,date:t,ht:r,delete_files:a,load_id:c,num:i},JournalTeacher.url),(function(t){if(!t.result&&''!==t.error)return rht&&rht.length>2&&d.removeClass('saved saving').addClass('notsave'),JournalTeacher.error(t.error);if(t.result&&n&&t.result.length===n.length){rht&&rht.length>2&&d.removeClass('saving notsave').addClass('saved');var r=0;$(n).each((function(e,a){$(a).attr('id','ht'+t.result[r]),$('<a href="#" style="display: inline;"><img src="/img/html-default/editht.png" /></a>').addClass('editHT').appendTo(a).hide(),$('<a href="#" style="display: inline;"><img src="/img/html-default/cancel.png" /></a>').addClass('removeHT').appendTo(a).hide(),r++}))}if(fast&&null!=window.parameters_redirect&&parameters_redirect){var a=$('#g'+JournalTeacher.grp+' table.homework tr[lnum="'+e+'"]'),i=a.find('.tdHT');i.html('');a.find('.tdData');(rht.length>0||''!==s)&&$(rht).each((function(e){i.children().length>0&&i.append($('<br />')),tod=this.date?to+' '+this.date.replace(/(....)-(..)-(..).*/,'$3.$2'):toholiday_label;var t='',r='';for(var a in void 0!==window.load_id&&(r='?lid='+c),rht[e].resource){var s=rht[e].resource[a],l=$('#modal-resources').find('a[data-id="'+s+'"]').first(),d=l.attr('data-hash'),u=l.text();t+=templateHtResourcesFile(s,d,u,r)}n[e]=$('<span></span>').addClass('hometaskItem').html(this.task+' ('+tod+')'+t).appendTo(i),$(o[e]).each((function(){$(this).appendTo(n[e])}))})),a.find('.tdInd span').toggleClass('checked',l)}}))},saveLessonHometaskIndividual:function(e,t,r,a,n,o,s,l,i,d){var c=0;null!=window.journal_load_ids&&null!=journal_load_ids[e]&&(c=journal_load_ids[e]);var u=$('#g'+e+'_homework > tr[lnum="'+n+'"] > td.tdInd');u.removeClass('saved notsave').addClass('saving'),jrpc.addParameter('presets',JSON.stringify(o)),jrpc.addParameter('tasks',JSON.stringify(s)),jrpc.addParameter('chkd',JSON.stringify(l)),jrpc.addParameter('unchkd',JSON.stringify(i)),jrpc.addParameter('rchkd',JSON.stringify(d)),jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.save_lesson_hometask_individual',{grp:e,'class':t,lesson_id:r,home_task_date:a,lesson_num:n,load_id:c},JournalTeacher.url),(function(e){if(!1===e.result&&''!==e.error)return u.removeClass('saved saving').addClass('notsave'),JournalTeacher.error(e.error);u.removeClass('saving notsave').addClass('saved')}))},deleteHometaskPreset:function(e){jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.delete_hometask_individual_preset',{preset_id:e},JournalTeacher.url),(function(e){!1===e.result&&''!==e.error&&JournalTeacher.error(e.error)}))},deleteHometaskIndividualFile:function(e){jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.delete_hometask_individual_file',{file_id:e},JournalTeacher.url),(function(e){!1===e.result&&''!==e.error&&JournalTeacher.error(e.error)}))},removeSubjectResources:function(e,t){var r=$('#subjectBlock .subject_resources').find('input');jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.remove_subject_resources',{'lesson_id':this.lesson_id,'class':this.cls,'grp':this.grp,'edit_lesson_num':t,'resources':JSON.stringify(e)},JournalTeacher.url),(function(t){if(!1===t.result&&''!==t.error)return JournalTeacher.error(t.error);r&&$(e).each((function(e,t){$(r).parent('label[data-id="'+t+'"]').remove()}))}))},removeTopicFiles:function(e){jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.remove_topic_files',{files:JSON.stringify(e)},JournalTeacher.url),(function(t){if(!1===t.result&&''!==t.error)return JournalTeacher.error(t.error);var r=$('#subjectBlock div[name="sjfiles"]').find('nobr'),a=$(r).find('a'),n=[];$(e).each((function(e,t){n.push(t.fid)})),a&&a.each((function(e,t){var r=t.href.replace(/.*\/(.*)\?filename=.*/,'$1'),a=''!==t.title?t.title:t.text,o=-1!==a.indexOf('.')?a.replace(/.*[.]/,''):'';n.includes(r)&&''!==o&&$('#subjectBlock div[name="sjfiles"]').find('nobr[fid="'+r+'"]').remove()}))}))},journalSaveSubjectAttachment:function(e,t){e=$(e);var r=$('#subjectBlock .subject_resources').find('a'),a=[],n=[],o=0;r&&r.each((function(e,t){t.pathname;var r=$(t).parent('label'),s=$(r).attr('data-id');$(t).siblings('input').prop('checked')?(a.push(s),o++):n.push(s)})),n.length>0&&JournalTeacher.removeSubjectResources(n,t);var s=$('#subjectBlock div[name="sjfiles"]').find('nobr'),l=[],i=0;s.each((function(e,t){$(t).find('input')&&!1===$(t).find('input').prop('checked')?l.push({'fid':$(t).attr('fid'),'title':$(t).find('a')?$(t).find('a').text():''}):i++})),l.length>0&&JournalTeacher.removeTopicFiles(l);var d=($('#subject').val()||'').trim(),c=$(e).find('.tdTopic'),u='См. приложения',p=r&&r.length,h=s&&s.length,m=p||h;(!p||0===o&&n.length>0)&&(!h||0===i&&l.length>0)&&(m=!1),d!==$('#subject').attr('placeholder')&&0!==d.length&&d!==u||(m?d=u:(d='',$('#subject').text('')));$(e);var _=$(e).attr('ldate');window.parameters_date=_;var f=$(e).attr('num');(c.attr('cwtxt1')||c.attr('cwtxt2')||c.attr('cwtxt3')||c.attr('cwtxt4'))&&(d=c.attr('cwtxt1')+c.attr('cwtxt2')+d+c.attr('cwtxt3')+' '+c.attr('cwtxt4'));var g=getPidOfLesson($(e));JournalTeacher.saveLessonTopic(t,_,d,f,g,[],a,!0)},saveLessonTopic:function(e,t,r,a,n,o,s,l){null==a&&(a=0),null!=(r=$.trim(r))&&null!=r&&'Null'!=r&&'null'!=r&&'undefined'!=r||(r=''),o=Array.isArray(o)&&o.length>0?JSON.stringify(o):'',s=Array.isArray(s)&&s.length>0?JSON.stringify(s):'',l=l||!1;var i=$('#g'+curgrp+'_homework > tr[lnum="'+e+'"] > td:not(.tdspacer):not(.tdHT):not(.tdInd)');i.removeClass('saved notsave').addClass('saving');var d=0;null!=window.journal_load_ids&&null!=journal_load_ids[this.grp]&&(d=journal_load_ids[this.grp]),''===r&&(n=''),jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.save_lesson_topic',{'lesson_id':this.lesson_id,'class':this.cls,'grp':this.grp,'lesson_num':e,'date':t,'subject':r,'load_id':d,'num':a,'pid':n,'files':o,'resources':s},JournalTeacher.url),(function(t){if(!1===t.result&&''!==t.error)return i.removeClass('saved saving').addClass('notsave'),JournalTeacher.error(t.error);i.removeClass('notsave saving'),(!l||l&&window.isSetPlanForGroup[JournalTeacher.grp])&&i.addClass('saved');var a=$('#g'+JournalTeacher.grp+' table.homework tr[lnum="'+e+'"]');if(setPidOfLesson(n,a),null!=window.parameters_redirect&&parameters_redirect){var o=a.find('tdTopic');o.html(''),''!==r?o.append(document.createTextNode(r)):o.append('<div class="b-href fill hidden">'+intl.get('Fill')+'</div>')}}))},saveLessonTopicExtDay:function(e,t,r,a,n,o,s){a=$.trim(a),n=null===n?'false':$.trim(n),jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.save_lesson_topic_extday',{grp:this.grp,date:e,start:t,end:r,subject:a,note:n,files_save:o,files_delete:s},JournalTeacher.url),(function(e){!1===e.result&&''!==e.error&&JournalTeacher.error(e.error)}))},sendRebuke:function(e,t,r,a,n,o,s,l){var i='r'!==e?'Ошибка! Не удалось отправить сообщение!':'Ошибка! Не удалось написать замечание в дневник!';fetch(window.theOnlyWayToGenerateUrlForMethodCall('teacher.send_rebuke',{},JournalTeacher.url),{method:'POST',headers:{Accept:'application/json','Content-Type':'application/json'},body:JSON.stringify({type:e,student:t,lesson_id:extday_journal?window.JournalConfig.lid:this.lesson_id,txt:r,date:a,with_clteach:n,headteach:o,selectionStudents:s,selectionGroups:l}),credentials:'include'}).then((function(e){return e.json()})).then((function(e){!1===e.result&&''!=e.error?JournalTeacher.error(e.error):''!==e.msg&&alert(e.msg,!1)})).catch((function(e){JournalTeacher.error(i)}))},delRebuke:function(e,t){return Boxy.confirm(msg_delrebuke,(function(){JournalTeacher.deleteRebuke(e,t)})),!1},deleteRebuke:function(e,t){jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.del_rebuke',{rebuke_id:e},JournalTeacher.url),(function(e){$(t).parent().parent().find('a').length>1?$(t).parent().html(''):$(t).parent().parent().parent().html('')}))},addColumn:function(e,t,r,a,n,o){return''==t&&(t='0'),jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.add_column',{'class':this.cls,lesson_id:this.lesson_id,grp:this.grp,date:e,num:t,nm:r,prev:a},JournalTeacher.url),(function(e){!1===e.result&&''!==e.error?JournalTeacher.error(e.error):e.nm!==r&&(n.attr('id',n.attr('id').replace(/(....-..-..[^N]*N)[^_]+(_.*)/,'$1'+e.nm+'$2')),o.attr('id',o.attr('id').replace(/(....-..-..[^N]*N)[^_]+(_.*)/,'$1'+e.nm+'$2')))})),!1},removeColumn:function(e,t,r,a,n,o){return''==t&&(t='0'),jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.remove_column',{'class':this.cls,'lesson_id':this.lesson_id,'grp':this.grp,'date':e,'num':t,'nm':r,'is_ht_column':a,'is_no_schedule':n,'is_two_lessons':o},JournalTeacher.url),(function(e){e?!1===e.result&&''!==e.error&&JournalTeacher.error(e.error):requestError(null)}),(function(e){requestError(e)})),!1},setPartMark:function(e,t,r,a,n,o){n=n||this.year,t=t||this.part;var s=pres?t.replace(/\_(.*)/,'$1'):t.replace(/(.*) .*/,'$1'),l=!1;if(n===this.year&&null!=allresults&&curgrp in allresults&&e in allresults[curgrp]){var i=!isNaN(r);if(''!==String(r).trim()&&!1!==r&&'н/а'!==r&&window.JournalConfig&&window.JournalConfig.roundResultTo&&window.JournalConfig.roundResultTo>0&&i&&(r=(r=parseFloat(r)).toFixed(window.JournalConfig.roundResultTo)),s in allresults[curgrp][e])allresults[curgrp][e][s]=r,void 0!==finalmarkbuf[e]&&void 0!==finalmarkbuf[e][this.year]&&(finalmarkbuf[e][this.year][s]=r);else if('Годовая'===s||'_Годовая'===s){void 0!==finalmarkbuf[e]&&void 0!==finalmarkbuf[e][this.year]&&(finalmarkbuf[e][this.year]['Годовая']=r);var d=0,c=0,u=0,p=!1;'н/а'===r?p=!0:''!==String(r).trim()&&!1!==r&&($.each(allresults[curgrp][e],(function(e,t){'н/а'!==t&&t!==teacherConfig.markDismissedOld&&t!=teacherConfig.markDismissed&&null!=t&&(d+=parseInt(t),c++)})),u=Math.roundToSign(d/c,2)),l={uid:$('#g'+curgrp+'_fio div[name="'+e+'"]').attr('uid'),avg:u,na_miss:p,na_mark:p},l=JSON.stringify(l)}else'Экзамен'===s||'_Экзамен'===s?void 0!==finalmarkbuf[e]&&void 0!==finalmarkbuf[e][this.year]&&(finalmarkbuf[e][this.year]['Экзамен']=r):'Внутр. экз.'===s||'_Внутр. экз.'===s?void 0!==finalmarkbuf[e]&&void 0!==finalmarkbuf[e][this.year]&&(finalmarkbuf[e][this.year]['Внутр. экз.']=r):'ОГЭ'!==s&&'_ОГЭ'!==s||void 0!==finalmarkbuf[e]&&void 0!==finalmarkbuf[e][this.year]&&(finalmarkbuf[e][this.year]['ОГЭ']=r)}var h=0;null!=window.journal_load_ids&&null!=journal_load_ids[this.grp]&&(h=journal_load_ids[this.grp]),null!=o&&MarksHighlighting.highlightCell(o,{savingStatus:'saving'}),jrpc.addParameter('comment',a),jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.set_part_mark',{'lesson_id':this.lesson_id,'student':e,'part':t,'year':n,'mark':r,'year_avg':l,'load_id':h},JournalTeacher.url),(function(e){e?!1===e.result&&''!==e.error?(null!=o&&MarksHighlighting.highlightCell(o,{savingStatus:'notsave'}),JournalTeacher.error(e.error)):null!=o&&MarksHighlighting.highlightCell(o,{savingStatus:'saved'}):requestError(null)}))},setAvg:function(e){return!!window.extday_journal||(!(!window.disableSetAvg&&''!==this.year&&''!==this.sp&&''!==this.lesson_id&&void 0!==this.year&&void 0!==this.sp&&void 0!==this.lesson_id)||(jrpc.addParameter('info',JSON.stringify(e)),void jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.set_avg',{year:this.year,sp:this.sp,lesson_id:this.lesson_id},JournalTeacher.url),(function(e){e?!1===e.result&&''!==e.error&&JournalTeacher.error(e.error):JournalTeacher.error(window.trans('error.generic'))}),(function(e){console.error(e)}))))},unlockMarks:function(e,t,r){var a=[],n=$('#'+e+t+'N'+r+'_'+curgrp).children('div.cell--locked');if(n.each((function(){a.push($(this).attr('name'))})),0===a.length)return!1;studentsJSON=JSON.stringify(a),jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.unlock_marks',{lesson_id:this.lesson_id,date:e,num:t,nm:r,students:studentsJSON},JournalTeacher.url),(function(e){if(!1===e.result&&''!==e.error)return JournalTeacher.error(e.error);n.each((function(){$(this).removeClass('cell--locked').prop('blockTime',!1)}))}))},setMark:function(e,t,r,a,n,o,s,l,i,d,c,u){c=c||0;var p=!1;(i=i||!1)&&(i=JSON.stringify(i),p=this.sp);var h=r>0?r.toString():'',m=a>0?a.toString():'0',_='#'+t+h+'N'+m+'_'+l,f=$(_).children('div[name="'+e.toString()+'"]'),g=f.parent(),w=g.attr('mt_id'),v=g.attr('max_mark'),k=g.attr('weight');MarksHighlighting.highlightCell(f,{savingStatus:'saving'});var b=journalParseMark({mark:n,max_mark:v,weight:k,markTypeId:w},window.JournalConfig,window.allow_marks,window.mtypes[curgrp]);!isSafeToSetMark(f)&&(n.length>0&&n!=(window.miss_symbol_small||'н')||'miss'==d&&window.JournalConfig&&!window.JournalConfig.allow_missmark)&&alert(intl.get('legacy.study.specmark.transform_specmark_journal_hint'));var y=0;null!=window.journal_load_ids&&null!=window.journal_load_ids[l]&&(y=journal_load_ids[l]),jrpc.addParameter('comment',o),jrpc.addParameter('avg_info',i),jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.set_mark',{'lesson_id':this.lesson_id,'student':e,'date':t,'num':r,'nm':a,'mark':n,'type':s,'grp':l,'sp':p,'load_id':y,'miss_type':d,'miss_minutes':c,'need_update_avg_cw_year':u?1:0},JournalTeacher.url),(function(r){if(r){if(!1===r.result&&''!==r.error)return MarksHighlighting.highlightCell(f,{savingStatus:'notsave'}),JournalTeacher.error(r.error);if(s>0&&0==a&&(window.hometask_journal||window.cw_codifier_journal)){MarksHighlighting.highlightCell(f,{savingStatus:'saved'});var o=r.nm;null!=o&&$('[id^="'+t+'"]').attr('mnm',o).find('cell').attr('mnm',o)}else if('function'==typeof journalCodifierAvg){MarksHighlighting.highlightCell(f,{savingStatus:'saved'});var l=$(_).attr('cw_id');n===(window.miss_symbol_small||'н')?($('#g'+curgrp+'_marks div.cells[column-type="task-column"][cw_id="'+l+'"] div[name="'+e+'"]').html(''),null!=kes[curgrp][l]&&$.each(kes[curgrp][l],(function(t,r){Object.keys(kes[curgrp][l][t].columns).length>0&&JournalTeacherCwCodifier.setTaskColumnMark(Object.keys(kes[curgrp][l][t].columns),l,t,e,!1)}))):null!=kes[curgrp][l]&&$.each(kes[curgrp][l],(function(t,r){if(Object.keys(kes[curgrp][l][t].columns).length>0){var a=[];$.each(kes[curgrp][l][t].columns,(function(t,r){null==r.marks[e]&&(a.push(t),$('#g'+curgrp+'_marks div.cells[column-type="task-column"][cw_id="'+l+'"][cw_task_column_id="'+t+'"] div[name="'+e+'"]').html('').append('<i class="fa gray fa-check fa-cell"></i>'))})),a.length>0&&JournalTeacherCwCodifier.setTaskColumnMark(a,l,t,e,0)}}))}else{if(r.avgCwYearMark){var i=$('#g'+curgrp+'_journal [id=g'+curgrp+'_avg_cw_years] div[name="'+e+'"]'),d=i.hasClass('cell_inactive'),c=i.text();(!d||d&&c.length)&&(i.text(r.avgCwYearMark),MarksHighlighting.highlightCell(i,{savingStatus:'saved'}))}if(MarksHighlighting.highlightCell(f,{savingStatus:'saved'}),window.JournalConfig&&!1!==window.JournalConfig.marks_block_after&&''!==b.mark){var u=60*parseInt(window.JournalConfig.marks_block_after)*1e3,p=f;f.attr('blockTime',(new Date).getTime()+u),setTimeout((function(){p.attr('blockTime','now').addClass('cell--locked')}),u)}}}else requestError(null)}),(function(e){requestError(e),MarksHighlighting.highlightCell(f,{savingStatus:'notsave'})}))},setMiss:function(e,t,r,a,n,o,s,l){var i=$('#'+t+(r>0?r.toString():'')+'N'+(a>0?a.toString():'0')+'_'+s+' > div[name="'+e.toString()+'"]'),d=i.parent();MarksHighlighting.highlightCell(i,{savingStatus:'saving'});var c=d.attr('mt_id'),u=d.attr('max_mark'),p=d.attr('weight'),h=i.find('input'),m='';if('late'!==n&&'miss'!==n||(m=getStudentComment(!0)),h.length>0){var _=$.trim(h.val().toLowerCase()),f=journalParseMark({mark:_,max_mark:u,weight:p,markTypeId:c},window.JournalConfig,window.allow_marks,window.mtypes[curgrp]);if(0==f)return void alert(errormsg);_=f.mark,'miss'===n&&0==f.miss&&(_=(window.miss_symbol_small||'н')+_),''===_&&'none'===n&&journalUpdateTooltip(i,'')}jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.set_miss',{'lesson_id':this.lesson_id,'student':e,'date':t,'num':r,'nm':a,'miss_type':n,'minutes':o,'comment':m,'class':this.cls,'grp':s},JournalTeacher.url),(function(e){if(!1===e.result&&''!==e.error)return MarksHighlighting.highlightCell(i,{savingStatus:'notsave'}),JournalTeacher.error(e.error);MarksHighlighting.highlightCell(i,{savingStatus:'saved'}),'miss'===n?(i.attr('miss_type','miss'),i.removeAttr('late_minutes'),o=''):'late'===n?i.attr('miss_type','late'):(i.removeAttr('miss_type'),i.removeAttr('late_minutes'),o=''),$('#g'+s+'_miss').toggleClass('active','miss'==n),window.current_input||$('#g'+s+'_late').toggleClass('active','late'==n),i.attr('late_minutes',o),h.length>0&&(h.val()!=_&&h.val(_),h.trigger('change-miss-type',[{keyCode:!0}])),l&&'function'==typeof l&&l()}))},setSpecMark:function(e,t,r,a,n,o){var s=$('#'+t+(r>0?r.toString():'')+'N'+(a>0?a.toString():'0')+'_'+o+' > div[name="'+e.toString()+'"]');MarksHighlighting.highlightCell(s,{savingStatus:'saving'}),jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.set_spec_mark',{lesson_id:this.lesson_id,student:e,date:t,num:r,nm:a,mark_id:n,'class':this.cls,grp:o},JournalTeacher.url),(function(e){if(!1===e.result&&''!==e.error)return MarksHighlighting.highlightCell(s,{savingStatus:'notsave'}),JournalTeacher.error(e.error);MarksHighlighting.highlightCell(s,{savingStatus:'saved'});var t=$('#g'+o+'_spec_marks'),r=$('#g'+o+'_spec_mark_'+n);if(0===t.length&&r.siblings().removeClass('active'),n>0){0===t.length&&r.addClass('active');var a=r.attr('spec_mark'),l=r.attr('data-specmark-transform-mark').length>0&&r.attr('data-specmark-transform-days').length>0;s.attr('spec_mark_id',n),s.attr('spec_mark',a),s.attr('spec_mark_transform',l?1:0)}else 0===t.length&&r.removeClass('active'),s.removeAttr('spec_mark_id'),s.removeAttr('spec_mark')}))},setExtDayFinalMark:function(e){jrpc.addParameter('data',e),jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.set_final_mark',{},JournalTeacher.url),(function(e){}))},createStudyRebuke:function(e,t,r,a){a=a||!1,jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.create_study_rebuke',{lid:e,text:t,review_id:r},JournalTeacher.url),(function(e){!1===e.result&&''!==e.error?JournalTeacher.error(e.error):a&&a(e.rid)}))},fixStudyRebuke:function(e){jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.fix_study_rebuke',{rebuke_id:e},JournalTeacher.url),(function(e){!1===e.result&&''!==e.error&&JournalTeacher.error(e.error)}))},viewStudyRebuke:function(e){jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.view_study_rebuke',{rebuke_id:e},JournalTeacher.url),(function(e){!1===e.result&&''!==e.error&&JournalTeacher.error(e.error)}))},closeStudyRebuke:function(e){jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.close_study_rebuke',{rebuke_id:e},JournalTeacher.url),(function(e){!1===e.result&&''!==e.error&&JournalTeacher.error(e.error)}))},rejectStudyRebuke:function(e){jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.reject_study_rebuke',{rebuke_id:e},JournalTeacher.url),(function(e){!1===e.result&&''!==e.error&&JournalTeacher.error(e.error)}))},removeStudyRebuke:function(e){jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.remove_study_rebuke',{rebuke_id:e},JournalTeacher.url),(function(e){!1===e.result&&''!==e.error&&JournalTeacher.error(e.error)}))},setHomeworkDayType:function(e,t){null==this.grp?grp=0:grp=this.grp,jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.set_homework_day_type',{date:e,lesson_id:this.lesson_id,grp:grp,'class':this.cls,type:t},JournalTeacher.url),(function(e){}))},addNoSchedule:function(e,t,r,a,n,o){jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.add_no_sched_lesson',{date:e,lesson_id:t,classes:JSON.stringify(r),subject:a,real_lesson_id:n,real_grp:o},JournalTeacher.url),(function(e){!1===e.result&&''!==e.error?JournalTeacher.error(e.error):setTimeout((function(){document.location.href='/journal-app/page.journal-app/class.'+r[0].class+'/lesson_id.'+t+'/grp.'+r[0].grp}),60)}))},setControlCodifiers:function(e,t,r,a,n,o){jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.set_control_codifier',{'class':this.cls,'lesson_id':this.lesson_id,'grp':e,'date':t,'num':r,'nm':a,'codifier_list':n,'codifier_type':o},JournalTeacher.url),(function(e){if(in_array(e.error,[void 0,''])){if(!0===e.result){var s=t+(0==r?'':r)+'N'+a;null==window.JournalConfig.groupsData[curgrp].codifiers[s]&&(window.JournalConfig.groupsData[curgrp].codifiers[s]={kes_list:[],kpu_list:[]}),window.JournalConfig.groupsData[curgrp].codifiers[s][o+'_list']=n}}else JournalTeacher.error(e.error)}))},setCriterialMarkFromEnum:function(e,t,r,a,n){jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.set_criterial_mark_from_enum',{'lesson_id':this.lesson_id,'student_id':e,'mark_control_type':t,'mark':r,'year':this.year,'part':this.sp},JournalTeacher.url),a,n)},deleteCriterialMark:function(e,t,r,a){jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.delete_criterial_mark',{'lesson_id':this.lesson_id,'student_id':e,'mark_control_type':t,'year':this.year,'part':this.sp},JournalTeacher.url),r,a)}},JournalGroups={url:'/journal-people-groups-rpc-action',setGroups:function(e){jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('people.groups.set_groups',{'username':e.user,'grp':e.group,'date':e.date,'order_number':e.order_number,'order_date':e.order_date},JournalGroups.url),(function(e){!1===e.result&&''!=e.error&&JournalTeacher.error(e.error)}))},unsetGroups:function(e){jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('people.groups.unset_groups',{'username':e.user,'grp':e.group,'date':e.date,'order_number':e.order_number,'order_date':e.order_date},JournalGroups.url),(function(e){!1===e.result&&''!=e.error&&JournalTeacher.error(e.error)}))}},schoolSettings={url:'/journal-index-rpc-teacher-action',setSchoolTitleFull:function(e){return jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.set_school_title_full',{title:e},schoolSettings.url)),!0},setClassOrderNum:function(e,t,r){return jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.set_class_order_num',{orderType:e,schoolClass:t,orderNum:r},schoolSettings.url)),!0},setClassOrderDate:function(e,t,r){return jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.set_class_order_date',{orderType:e,schoolClass:t,orderDate:r},schoolSettings.url)),!0},addToQueueForPrintJournal:function(e,t,r,a,n,o){return jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.add_to_queue_for_print_journal',{dep:e,schoolClass:t,lessons:r,studyParts:a,extDayDep:n,year:o},schoolSettings.url)),!0}};function journalExplodeDate(e,t){if(t=t||curcol,e=e||t.id,!(t&&null!=t||e&&null!=e))return!1;if(t){var r=$(t).data('column-title');if(r)return{part:r}}return e=='g'+curgrp+'_yearly'?{part:'Годовая'}:pres?/\s[0-9]{1,2}\sкл\./.test(e)?(part=e.replace(/([^_]*)\s[0-9]{1,2}\sкл\._.*/,'$1'),{part:part}):(part=e.replace(/([^_]*)_.*/,'$1'),{part:part}):(cdate=e.replace(/(....-..-..).*/,'$1'),cnum=e.replace(/....-..-..([^N]*)N.*/,'$1'),cnm=e.replace(/.*N([^_]*)_.*/,'$1'),nosched=$(t).parent().attr('nosched'),twoless=$(t).parent().attr('twoless'),{date:cdate,num:cnum,nm:cnm,nosched:nosched,twoless:twoless})}var fast,exttoclass={doc:'doc',docx:'doc',xls:'xls',xlsx:'xls',pdf:'pdf',jpg:'jpg',jpeg:'jpg',gif:'jpg',bmp:'jpg',png:'jpg',tiff:'jpg',rar:'rar',zip:'zip',txt:'att'};function journalUploadSubmit(e,t,r){(e=$(e)).find('br').length>0&&e.append('<br/>');var a=['<nobr id="',hex_md5(t),'">','<input type="checkbox" disabled/>','<img src="/img/html-default/spacer.gif" alt="" class="attach ',exttoclass[r]?exttoclass[r]:'att','"/>','&nbsp;<span>',loading_label||'Загрузка','</span>','</nobr>'];return e.append(a.join('')),!0}function journalUploadResponse(e,t,r){if(nobr=$('nobr[id=\''+hex_md5(t)+'\']'),r.state){var a=r.url.match(/\/\/[^\/]+(\/.+)/)[1];nobr.attr('id','fid_'+r.file).attr('filename',r.name).attr('fid',r.file).attr('url',a).find('span').html('<a class="lblue notd" target="_blank" href="'+a+'">'+r.name+'</a>'),nobr.find('input').attr('checked',!0).prop('disabled',!1)}else{var n=errorupload_label,o=r.error;if('wrong_size'===r.error_code){var s=r.error.replace('G',' Г').replace('M',' М').replace('K',' К');n=errorupload_label_size_max+' '+s+errorupload_label_byte,o=errorupload_label_size+'. '+n}''!==o&&alert(o),nobr.fadeTo('slow',.5).attr('id','').find('span').text(n)}return!0}function journalChangeSubject(e){var t=$('#subject'),r=HometaskAddData.currentLesson.num;HometaskAddData.lessonsSubjects[r]=t.val(),HometaskAddData.currentLesson.num=e.value;var a=e.value;t.val(HometaskAddData.lessonsSubjects[a]),$('tr.htedit[data-num="'+r+'"]').addClass('hide'),$('tr.htnew[data-num="'+r+'"]').addClass('hide'),$('tr.htedit[data-num="'+a+'"]').removeClass('hide'),$('tr.htnew[data-num="'+a+'"]').removeClass('hide');var n=$('#subjectTr');return $('#planr, #setHomeTaskByPlan, #setHomeTaskByPlan').prop('disabled',!0),journalSubject(n,0,HometaskAddData.currentLesson.num),!1}function journalAddHometask(e){fast=$('#pgrp').length>0,elem=fast?'.setHomeTask':'#newht';var t=$(elem+' tbody tr').length-1,r=$(e).data('num'),a=$('<tr name="hometask" data-num="'+r+'" class="htnew">'+$(e).html()+'</tr>');$(e.parentNode).append(a),$(a).find('.hometask-lessons__files-switch').prop('checked',!1),$(a).find('.hometask-lessons__files-comment').addClass('hide'),fast||($(e).find('#ht_submit').remove(),$('#ht_date').attr('rowspan',t+2),$('#btnSpace').attr('rowspan',t+1)),$(e).find('.button--blue.button--icon').remove(),$(e).find('input.field--right').removeClass('field--right').addClass('field'),t++;var n='upload_'+window.guidIdGenerator(),o=a.find('div[name="htfiles"]');return o.find('[id^="upload_"]').attr('id',n),o.find('nobr').remove(),a.find('.modal-resource-files, .journal-resource-files').html(''),a.find('textarea.hometask-lessons__input-field, input[name=task]').attr('id','ubel'+t),a.find('div.user_buttons').attr('id','ub'+t),a.find('ej-switcher.hometask-lessons__files-switch').attr('id','hlfs'+t),a.find('input.hometask-lessons__files-comment').attr('id','hlfc'+t),$((function(){new AjaxUpload(n,{action:storage.upload,name:'userfile',autoSubmit:!0,responseType:'json',onSubmit:function(e,t){return journalUploadSubmit(this._button.parentNode.parentNode,e,t)},onComplete:function(e,t){return journalUploadResponse(this._button.parentNode.parentNode,e,t)}})})),journalUserButtons(t),$(elem+' tbody tr:last input[name="task"]').attr('prev_value',''),!1}function journalSetHometask(e){$(e).find('#subject').trigger('focusout'),fast=$('#pgrp').length>0;var t='',r=[],a=[],n=[],o=[],s=!1,l='',i=!1;if($(fast?'#tabs-common':e).find('[name="task"]').each((function(e){var t=$(this),r=t.parents('.hometask-container');s=!0===r.find('[name=email_switch]').prop('checked');var l=r.find('nobr[id!=0] > input:checked'),d=r.find('div.modal-resource-files,div.journal-resource-files').find('label').children('input:checked'),c=l.length>0||d.length>0,u=$.trim(t.val());u===t.attr('placeholder')&&(u='');var p=r.find('[name=htminutes]'),h=parseInt($.trim(p.val()),10);if((''!=u||c)&&(''==$.trim(p.val())||isNaN(h))&&p.prop('required'))return p.addClass('field--invalid').trigger('focus'),alert('Укажите время, заложенное на выполнение ДЗ.'),i=!0,!1;if(p.val(h),''!==u||c){var m=[],_=[];l.each((function(e){var t=$(this.parentNode);m.push({'fid':t.attr('fid')?t.attr('fid'):t.attr('id').substr(4),'url':t.attr('url'),'filename':t.attr('filename')}),(!fast||null!=window.parameters_redirect&&parameters_redirect)&&(_[_.length]=$('<a href="'+m[m.length-1].url+'"></a>').attr('title',m[m.length-1].filename).append($(this).parent().find('img').attr('title',m.filename)))})),r.find('nobr[id!=0] > input:not(:checked)').each((function(e){var t=$(this.parentNode);n.push({'id':t.attr('id').substr(4)})})),u=''==u?seefiles_txt:u;var f=[],g=[];d.each((function(){f.push($(this).val()),g.push($(this).parent())}));var w=r.find('select[name=htdate]'),v=w.val()?w.val():null;if(window.hometask_max_datetime&&v){var k=!1,b=!1,y=new Date(v.replace(/(\d+)-(\d+)-(\d+)/,'$2/$3/$1')),C=new Date,j=new Date(C.getFullYear(),C.getMonth(),C.getDate()),T=new Date(j.valueOf()+864e5);if(T.valueOf()>y.valueOf()&&(k=!0),T.valueOf()==y.valueOf()){var x=parseInt(window.hometask_max_datetime);x&&C.valueOf()>1e3*x&&(k=!0,b=!0)}if(k){w.addClass('field--invalid').trigger('focus');var J=b?'Вы не можете записать<br/>домашнее задание на завтра после '+(1e3*x-j.valueOf())/36e5+':00!':'Запись домашнего задания задним числом запрещена!';return alert(J,!0),i=!0,!1}}var S=!0===r.find('[name=files_switch]').prop('checked'),M=r.find('[name=files_comment]').val();a.push({date:v,lnum:$(this).parent().parent().parent().data('num'),task:u,collect_files:S,collect_files_comment:M,files:m,minutes:p.val()>0&&p.val(),resource:f,resourceData:g,send_email:s}),o[o.length]=_}})),i)return!1;haveind=!1,$('#tabs_presets').children('.preset').each((function(){txt=$(this).find('input[id^=ubeli]'),fs=$(this).find('input[checked]').length,txt.val()!=txt.attr('placeholder')&&''!=txt.val()&&hometaskSaveEnabled()&&(haveind=!0)}));var d=0;if(fast){window.HometaskAddData&&window.HometaskAddData.currentLesson&&(d=window.HometaskAddData.currentLesson.idOnPage),window.Modals.hide('#modal');var c=$('#lesnum').get(0);lnum=c?c.value:lessonnum}else{$(e).find('span.hometaskItem a.editHT, span.hometaskItem a.removeHT').hide(),$(e).removeClass('trEditHT').addClass('trLes');var u=$(e).find('.tdHT');$(e).find('.tdData');$(e).find('td').css({'background-color':''}),t=$.trim($('#subject').val());var p=$('#subjectBlock .subject_resources').find('a'),h=[],m='',_=0;p&&p.each((function(e,t){var r=t.href,a=$(t).parent('label'),n=$(a).attr('data-id'),o=$(a).attr('data-hash'),s=$(a).attr('data-title'),l=0===o.indexOf('ya_')?'resource-icon-yaclass offset10':'blue fa fa-link lh16 offset10';$(t).siblings('input').prop('checked')?(m+=' <a href="'+r+'" data-id="'+n+'" data-hash="'+o+'" data-title="'+s+'" title="'+s+'" class="'+l+'" target="_new"></a>',_++):h.push(n)}));var f=$('#subjectBlock div[name="sjfiles"]').find('nobr'),g=$(f).find('a'),w=[],v=0;f.each((function(e,t){$(t).find('input')&&!1===$(t).find('input').prop('checked')?w.push($(t).attr('fid')):v++}));var k='';g&&g.each((function(e,t){var r=t.href,a=r.replace(/.*\/(.*)\?filename=.*/,'$1'),n=''!==t.title?t.title:t.text,o=-1!==n.indexOf('.')?n.replace(/.*[.]/,''):'';w.includes(a)||''===o||(k+=' <a href="'+r+'" title="'+n+'" target="_blank"><img class="attach '+(exttoclass[o]?exttoclass[o]:'att')+'" alt="" src="/img/html-default/spacer.gif" title="'+n+'" /></a> ')}));var b=($('#subject').val()||'').trim();(h.length>0||w.length>0||m.length>0||k.length>0||k.length>0||b!==$('#subject').attr('placeholder')&&b.length>0)&&JournalTeacher.journalSaveSubjectAttachment(e,$(e).attr('lnum'));$(e).find('.tdTopic');var y=p&&p.length,C=f&&f.length,j=y||C;(!y||0===_&&h.length>0)&&(!C||0===v&&w.length>0)&&(j=!1);var T=b;b!==$('#subject').attr('placeholder')&&0!==b.length&&b!==seefiles_txt||(T=j?seefiles_txt:''),t=t==$('#subject').attr('placeholder')?'':t,(a.length>0||''!=t)&&$(a).each((function(e){l=this.date?to+' '+this.date.replace(/(....)-(..)-(..).*/,'$3.$2'):toholiday_label;var t=this.minutes?'<span class="lgray offsetRight10">&nbsp;&ndash;&nbsp;<span class="minutes">'+this.minutes+'&prime;</span></span>':'',n=collectingFilesEnabled&&this.collect_files?'<i class="collect_files_info offset6 fa fa-upload lgray" title="'+this.collect_files_comment.replace(/"/g,'&quot;')+'"></i>':'',s='';for(var i in a[e].resource){var d=a[e].resource[i],c=$(a[e].resourceData[i]).first(),p=c.attr('data-hash'),h=c.text(),m='';void 0!==window.journal_load_ids&&void 0!==window.curgrp&&(m='?lid='+journal_load_ids[curgrp]),s+=templateHtResourcesFile(d,p,h,m)}u.find('p').length>0?r[e]=$('<span></span>').addClass('hometaskItem').html(this.task+' ('+l+')'+t+n+s).insertBefore(u.find('p')):r[e]=$('<span></span>').addClass('hometaskItem').html(this.task+' ('+l+')'+t+n+s).appendTo(u),$(o[e]).each((function(){$(this).appendTo(r[e])}))}));var x=$('#subjectBlock').parent().html(''),J='';x.attr('cwtxt1')?x.append('<span class="cw-text">'+x.attr('cwtxt1')+x.attr('cwtxt2')+'</span>'):J='hidden',''!==t||k.trim().length>0||m.trim().length>0?x.append([T,k,m].join(' ')):x.append('<span class="b-href fill '+J+'" xls_notext="1">'+window.filltask+'</span>'),x.attr('cwtxt3')&&x.append('<span class="cw-text">'+x.attr('cwtxt3')+'</span>'),x.attr('cwtxt4')&&x.append(' <span class="cw-text">'+x.attr('cwtxt4')+'</span>'),$(e).find('.tdData').children().css('background',''),u.find('table').remove(),u.find('.journal_hometask__header').remove(),lnum=$(e).attr('lnum'),d=$(e).attr('num')}return null!=window.parameters_redirect&&parameters_redirect&&(t=(t=$.trim($('#subject').val()))==$('#subject').attr('placeholder')?'':t),JournalTeacher.saveLessonHometask(lnum,parameters_date,a,n,r,o,t,haveind,d),$('[data-edit_task]').length>0&&$.each($('[data-edit_task]'),(function(e,t){journalRemoveHometask(t,!1,!0)})),$('.illegitimateAjaxUploadInput[name="userfile"]').parent().detach(),!1}function journalEditHometask(e){if($(e).attr('data-edit_task',$(e).attr('id')).addClass('hide'),el=$('textarea[name=task]').last(),(''!==el.val()&&el.val()!=el.attr('placeholder')||el.parent().find('[name=htfiles] nobr').length>0)&&(journalAddHometask(el.get(0).parentNode.parentNode.parentNode),el=$('textarea[name=task]').last()),pos=$.trim($(e).text()).indexOf(' ('+toholiday_label+')'),-1!=pos){el.val($.trim($(e).text()).substr(0,pos)).removeClass('placeholder');var t=toholiday_label}else{el.val($.trim($(e).text().replace(/([\s\S]*) \(.* ..\...\).*/,'$1'))).removeClass('placeholder');t=$.trim($(e).text().replace(/[\s\S]* \(.* (..\...)\).*/,'$1'))}var r;$(e).find('span.minutes').length>0&&$(el).parent().find('input[name=htminutes]').val($(e).find('span.minutes').text()),$(e).find('i.collect_files_info').length>0&&($(el).parent().parent().find('ej-switcher[name=files_switch]').prop('checked',!0),$(el).parent().parent().find('ej-switcher[name=files_switch]').prop('label',''),$(el).parent().parent().find('input[name=files_comment]').removeClass('hide'),$(el).parent().parent().find('input[name=files_comment]').val($(e).find('i.collect_files_info').attr('title'))),ds=el.parents('.hometask-container').find('select.hometask-lessons__input-date__select'),ds.children('option').each((function(){$(this).text()==t&&(r=$(this).val())})),null!=r&&ds.val(r);var a=$(el).parents('.hometask-container').find('[name=htfiles]');if($(e).find('a:not(.editHT):not(.removeHT):not(.resource-item)').each((function(){var e=a.children().last().get(0);e&&'NOBR'===e.nodeName&&$('<br />').appendTo(a);var t=this.href.replace(/.*\/(.*)\?filename=.*/,'$1'),r=this.href,n=document.createElement('span');n.innerHTML='&nbsp;';var o=document.createElement('a');o.href=this.href,o.className='lblue notd',o.innerHTML=this.title,n.appendChild(o),$('<nobr></nobr>').attr('id','fid_'+t).attr('filename',this.title).attr('fid',t).attr('url',r).append($('<input type="checkbox" />').attr('checked',!0)).append(this.firstChild).append(n).appendTo(a)})),window.templateResourcesFile){var n=$(el).parents('.hometask-container').find('div.journal-resource-files');$(e).find('a.resource-item').each((function(){var e=$(this).attr('data-id'),t=$(this).attr('data-hash'),r=$(this).attr('data-title'),a=$(this).attr('href');n.append('<div>'+templateResourcesFile(e,t,r,a)+'</div>')}))}}function journalRemoveHometask(e,t,r){(r=r||!1)?removeHT(e,t):Boxy.confirm(intl_AreYouSureWantToDeleteHT,(function(){removeHT(e,t)}),{})}function removeHT(e,t){if(e){var r=$(e),a=!1,n=r.data('to_date');if(window.hometask_max_datetime&&n){var o=!1,s=new Date(n.replace(/(\d+)-(\d+)-(\d+)/,'$2/$3/$1')),l=new Date,i=new Date(l.getFullYear(),l.getMonth(),l.getDate()),d=new Date(i.valueOf()+864e5);if(d.valueOf()>s.valueOf()&&(a=!0),d.valueOf()==s.valueOf()){var c=parseInt(window.hometask_max_datetime);c&&l.valueOf()>1e3*c&&(a=!0,o=!0)}if(a){var u=o?'Вы не можете записать<br/>домашнее задание на завтра после '+(1e3*c-i.valueOf())/36e5+':00!':'Запись домашнего задания задним числом запрещена!';return alert(u,!0),!1}}if(!a){var p=r.parents('tr.trEditHT').attr('num');JournalTeacher.removeHometask(e.id.substr(2),t,p,(function(){var t=$(e.parentNode);r.remove(),t.find('br + br, br:first-child, br:last-child').remove(),t.find('br + table').prev().remove()}))}}}function journalChangeGrp(e,t,r){var a=window.curgrp;e=void 0!==e?parseInt(e,10):0,r=r||0!=window.curgrp&&window.curgrp!=e;var n=null,o=$('#subjectBlock');if(window.hookLegacyBeforeChangeGroup&&window.hookLegacyBeforeChangeGroup instanceof Function&&window.hookLegacyBeforeChangeGroup(e,a),journalCancelRebuke(),window.first_run||t||(n=$(document).scrollTop()),r&&(current_mtype=null),window.isRating){var s,l=$('#g'+e+'_scroller_header .cells'),i=0,d=0;l.each((function(){var e=$(this),t=e.attr('mt_id'),r=e.attr('mt_control'),a=e.attr('weight')||1,n=e.attr('max_mark');if('0'!==t){var o=parseFloat(n)*parseFloat(a);o&&('1'===r?i+=parseFloat(o):d+=parseFloat(o))}})),s=i+d,part_max_mark_on?$('#g'+e+'_max_mark_current_rating').html(s):$('#g'+e+'_max_mark_rating').html(s),$('#g'+e+'_max_mark_rating_cw').html(i),$('#g'+e+'_max_mark_rating_not_cw').html(d)}if(curcol){if(journalSaveMarkClk(window.curgrp,pres,!1,!0),curcol)return window.first_run=!1,!1}else if(o.length>0&&(journalSetHometask(o.get(0).parentNode.parentNode),o.length>0))return window.first_run=!1,!1;bmark&&journalButtonMark(),Object.values(grps).forEach((function(e){!0!==t&&$('#g'+e+'_journal, #g'+e+'_journal_header, #fixedHeaderContainer, #g'+e+'_dsel, #g'+e+'_cw, #g'+e+'_header, #g'+e+', #g'+e+'_footer, .g'+e+'_clear').hide(),$('[name=gsel'+e+']').removeClass('actgroup')})),!0!==t&&($('#loading').hide(),$('#g'+e+'_header, #g'+e+'_journal, #g'+e+'_journal_header, #fixedHeaderContainer, #g'+e+'_dsel,  #g'+e+'_cw, #g'+e+', #g'+e+'_footer, .g'+e+'_clear').show()),isExpanded=$('#g'+e+'_marks i:visible').length>0,$('[name="gsel'+e+'"]').addClass('actgroup'),'undefined'!=typeof loadTodoList&&void 0!==window.journal_load_ids&&todoLoadCounterUpdate(e),!0===t||void 0===window.pr&&!0!==window.hometask_journal&&!0!==window.cw_codifier_journal||journalSetScrollerW(e),$('.mtypes').val('null'),window.curgrp=e,maxlnum=!1,JournalTeacher&&JournalTeacher.setGroup(window.curgrp);var c=function(e,t){var r=e.split('#');return r[0]=r[0].replace(/(.*)\/grp\.\d*(\/.*)?/,'$1$2')+'/grp.'+t,r[0]};if(r&&($('#navigation-tabs a').each((function(){this.href=c(this.href,window.curgrp)})),window.history.pushState(null,null,c(window.location.href,window.curgrp))),void 0!==window.udate&&1==udate[window.curgrp]&&window.Modals.show({width:350,url:'/journal-index-twolesson-action/part.'+JournalTeacher.part+'/class.'+JournalTeacher.cls+'/lesson_id.'+JournalTeacher.lesson_id+'/grp.'+window.curgrp,footer:!0,title:'Выберите предметы',onShown:function(){$('#modal-loading').hide(),$('#modal-save').off('click').on('click',(function(e){e.preventDefault();var t=[],r=[],a=[];if($('#twoles').find('tr').each((function(){var e=$(this).find('td[ldate]').attr('ldate');e&&(''!=$(this).find('select').val()?(t.indexOf(e)<0&&t.push(e),r.indexOf(e)>=0&&a.indexOf(e)<0&&a.push(e)):(r.indexOf(e)<0&&r.push(e),t.indexOf(e)>=0&&a.indexOf(e)<0&&a.push(e)))})),a.length>0){for(var n in a)$('#twoles').find('select[name^="tl'+a[n]+'"]').css('background','red');alert(intl.get('legacy.study.journal.two_lessons_choose_one_date'))}else $('#twolesson_form').trigger('submit')})),udate[window.curgrp]=0}}),!window.posMode||0==window.posMode||t||window.first_run&&!window.markTypeSwitch)null!==n&&$(document).scrollTop(n);else{var u=$('#fixedHeaderContainer').position();if(u&&u.top){var p=$(document).scrollTop();$(document).scrollTop(u.top+p+4)}}!0!==t&&fixedHeaderSet(e),null==mtypes&&(mtypes=[]),null==mtypes[window.curgrp]&&(mtypes[window.curgrp]=[]),null==mtypes[window.curgrp][0]&&(mtypes[window.curgrp][0]={id:0,control:0});var h=$('#teacher-rebuke');if(h.length>0&&void 0!==window.journal_load_ids&&Object.keys(window.journal_load_ids).length>0){var m=$('#teacher-rebuke-icon'),_=$('#teacher-rebuke-list'),f=m.hasClass('as-admin')?'create':'list',g='list'==f?_:m;'list'==f&&(null!=window.load_ids_rebukes&&null!=load_ids_rebukes[journal_load_ids[window.curgrp]]&&load_ids_rebukes[journal_load_ids[window.curgrp]]>0?_.find('span').html(load_ids_rebukes[journal_load_ids[window.curgrp]]):g=m);var w='/journal-study-monitor-journal-rebuke'+(window.extday_journal?'do':'')+'-'+f+'-action/lid.'+window.journal_load_ids[window.curgrp];g.attr('href',w),g.removeClass('hide'),h.removeClass('hide')}return window.hookLegacyAfterChangeGroup&&window.hookLegacyAfterChangeGroup instanceof Function&&window.hookLegacyAfterChangeGroup(e,a),window.first_run=!1,!1}var curcol=!1,prevcol=!1,saved=!1,curel=!1,curg=!1,pres=!1,editpmark=!1;function journalEditMark(e){for(var t=document.getElementById('g'+e+'_date').value,r=document.getElementsByTagName('TD'),a=0;a<r.length;a++)if(0==r[a].id.indexOf(t)&&r[a].parentNode.id=='g'+e+'_marks'){for(var n=r[a].getElementsByTagName('td'),o=0;o<n.length&&!(n[o].className.indexOf('td1',0)<0);o++);break}return journalEditMarkClk(e,n[o],!1)}function journalEditMarkClk(e,t,r,a){if(t=t||!1,'null'==a)return alert('Выставление отметок в данную колонку возможно только после указания КЭС.'),!1;if(curcol){if(curcol==e.parentNode)return!1;if(saved?saved=!1:prevcol=curcol,journalSaveMarkClk(curgrp,t),curcol)return prevcol=!1,!1}curcol=e.parentNode;var n=$(curcol).data('columnType');editpmark=curcol.id=='g'+curgrp+'_pmarks'||curcol.id=='g'+curgrp+'_yearly'||curcol.id=='g'+curgrp+'_extra'||'part'==n||'inner_exam'==n||'result'==n||'extFinalMark'==n,window.tabi=4,window.tabii=1,p=journalExplodeDate();var o,s,l,i=$(curcol).hasClass('cells_hanging');if(o=pres||'result'==n||'extFinalMark'==n?{mpart:p.part,needsave:'no'}:{mdate:p.date,mnum:p.num,mnm:p.nm,needsave:'no'},null==r||!1===r)s=$('#g'+curgrp+'_dedit'),l=$('#g'+curgrp+'_cwedit, #g'+curgrp+'_task_column_edit');else if('task'==r){s=$('#g'+curgrp+'_cwedit'),l=$('#g'+curgrp+'_dedit, #g'+curgrp+'_task_column_edit');var d=$(curcol).attr('cw_id'),c=1,u='basic';null!=a&&'null'!=a&&(c=kes[curgrp][d][a].info.max_mark,u=kes[curgrp][d][a].info.level),$('#g'+curgrp+'_max_mark').val(c).trigger('refresh'),$('#g'+curgrp+'_level').val(u).trigger('refresh'),$('#g'+curgrp+'_kes_num').html($(curcol).attr('num')),$('#g'+curgrp+'_k_title').hide()}else if('task-column'==r){s=$('#g'+curgrp+'_task_column_edit'),l=$('#g'+curgrp+'_dedit, #g'+curgrp+'_cwedit'),$('#g'+curgrp+'_task_num').html($(curcol).attr('num'));var h=$(curcol).attr('kes_id'),m=$(curcol).attr('kpu_id');'null'!=h?$('#g'+curgrp+'_task_column_title').html('<span class="lgray">КЭС</span> '+kesAll[h].paragraph+'. '+kesAll[h].content).show():'null'!=m&&$('#g'+curgrp+'_task_column_title').html('<span class="lgray">КПУ</span> '+kpuAll[m].paragraph+'. '+kpuAll[m].content).show()}if(s){if($('#g'+curgrp+'_dsel, #g'+curgrp+'_cw, #g'+curgrp+'_dsel_mb').hide(),s.showClassy(!0),l.hideClassy(!0),editpmark||pres){var _;$('#g'+curgrp+'_removecol').hide(),_='Итоговая'===(_='result'!==n&&'part'!==n&&'extFinalMark'!==n||!p.part?curcol.id==='g'+curgrp+'_yearly'?'Годовая':curcol.id==='g'+curgrp+'_extra'?'Экстра':pres?p.part:$('#psp').val():p.part.toString())?_.substr(0,4):'inner_exam'===n||window.JournalConfig&&window.JournalConfig.intl&&window.JournalConfig.intl.inner_exam&&_===window.JournalConfig.intl.inner_exam?window.JournalConfig.intl.inner_exam_short?window.JournalConfig.intl.inner_exam_short:$('#inner_exam_short').val():'string'==typeof _?_.substr(0,3):'',$('#g'+curgrp+'_edate').html(_),$('#g'+curgrp+'_mt').val(0).prop('disabled',!0).trigger('refresh'),$('#g'+curgrp+'_comment').prop('disabled',!0)}else{var f;num=0==p.num?'':p.num,f=window.hometask_journal||window.cw_codifier_journal?$(curcol).attr('mnm'):p.nm;var g=p.date+p.num+'N'+f;$('#g'+curgrp+'_edate').html(g.replace(/(....)-(..)-(..).*/,'$3.$2'));var w=window.comments;if(1==i)$('#g'+curgrp+'_comment').removeClass('placeholder').val('').prop('disabled',!0).removeAttr('placeholder').trigger('blur');else if(w&&w[curgrp]&&w[curgrp][g]&&w[curgrp][g].comment){var v=w[curgrp][g].comment;v=v.split('&raquo;').join('"').split('&laquo;').join('"'),$('#g'+curgrp+'_comment').removeClass('placeholder').val(v).prop('disabled',!1).trigger('blur')}else $('#g'+curgrp+'_comment').val('').prop('disabled',!1).trigger('blur');$('#g'+curgrp+'_removecol').toggleClassy((p.nm&&Number(p.nm)>0||'yes'===p.nosched||'yes'===p.twoless)&&!i);var k=$(curcol).attr('mt_id');if(i?$('#g'+curgrp+'_mt').val(k).prop('disabled',!0).trigger('refresh'):!0!==window.hometask_journal&&!0!==window.cw_codifier_journal&&$('#g'+curgrp+'_mt').val(k).prop('disabled',!1).trigger('refresh'),window.isRating&&max_mark_on&&Number(k)>0){$('#g'+curgrp+'_mt').parent().removeClass('column-50').addClass('column-44'),$('#g'+curgrp+'_max_mark').parent().show();var b=$(curcol).attr('max_mark');b&&$('#g'+curgrp+'_max_mark').val(b)}else'task'!=r&&($('#g'+curgrp+'_mt').parent().removeClass('column-44').addClass('column-50'),$('#g'+curgrp+'_max_mark').parent().hide());'miss'===$(e).attr('miss_type')?$('#g'+curgrp+'_miss').addClass('active'):$('#g'+curgrp+'_miss').removeClass('active'),$('#g'+curgrp+'_dedit').find('.spec_mark_button').removeClass('active'),null!=$(e).attr('spec_mark_id')&&$('#g'+curgrp+'_spec_mark_'+$(e).attr('spec_mark_id')).addClass('active');var y=[],C=[];void 0!==window.JournalConfig&&void 0!==window.JournalConfig.groupsData&&void 0!==window.JournalConfig.groupsData[curgrp]&&null!=window.JournalConfig.groupsData[curgrp].codifiers[g]&&(y=window.JournalConfig.groupsData[curgrp].codifiers[g].kes_list,C=window.JournalConfig.groupsData[curgrp].codifiers[g].kpu_list),$('#g'+curgrp+'_kes').val(y).trigger('refresh'),$('#g'+curgrp+'_kpu').val(C).trigger('refresh'),'yes'===$(curcol).attr('cw')?($('#g'+curgrp+'_kes_kpu').addClass('hide'),$('#g'+curgrp+'_kr_kes_kpu').removeClass('hide')):($('#g'+curgrp+'_kes_kpu').removeClass('hide'),$('#g'+curgrp+'_kr_kes_kpu').addClass('hide'))}$('#g'+curgrp+'_miss_control').find('input, button').each((function(){$(this).prop('disabled',editpmark),editpmark&&$(this).removeClass('active')}))}else $('#g'+curgrp+'_econtrol').show();return journalEditMarkInputs(e,tabi,tabii,o),!1}function journalEditMarkInputs(e,t,r,a){var n=$(curcol).data('columnType'),o=curcol.id.indexOf('_avg')>-1||'avg'==n,s=!o&&(curcol.id.indexOf('_part')>-1||'part'==n||'result'==n),l=!(o||s||$('#Grid').is('.grid--one_and_half, .grid--double, .grid--one_and_half_width, .grid--double_width')||$(curcol).is('.cells_one_and_half_width, .cells_double_width'));Array.from(curcol.children).forEach((function(e){if(e&&e.classList.contains('cell')&&(!e.classList.contains('cell_inactive')||e.classList.contains('editable'))){var t,r=e.querySelector('.cell-data');t=(t=null===r?e.innerText:r.innerText)?t.trim().toLowerCase():'','miss'==e.getAttribute('miss_type')&&t!==(window.miss_symbol_small||'н')&&(t=(window.miss_symbol||'Н')+t);var n=4;window.JournalConfig&&(o&&window.JournalConfig.roundAvgTo>0?n=2+window.JournalConfig.roundAvgTo:s&&window.JournalConfig.roundResultTo>0&&(n=2+window.JournalConfig.roundResultTo));var i=e.classList.contains('cell_inactive')&&!e.classList.contains('editable'),d='<input type="text" tabindex="'+window.tabi+'" onfocus="curel='+window.tabii+'-1;" onblur="curel=-1;" value="'+t+'" name="'+e.getAttribute('name')+'" maxlength="'+n+'" autocomplete="off" ';Object.keys(a).forEach((function(e){d+=' '+e+'="'+a[e]+'"'})),i?d+=' style="display:none"':(e.classList.add('markedit'),l&&isLongMark(t)&&(d+=' class="small"')),d+=' />',e.innerHTML=d,window.tabi=(window.tabi||0)+1,window.tabii=(window.tabii||0)+1,e.classList.contains('comm')&&($('#tooltip').hide(),$(e).tooltip({title2:!0}))}})),e.parentNode.classList.add('cells_editing'),setCaretPosition($(e).find('input').trigger('focusin').trigger('focus').get(0),10)}function updateSpecMarkColor(e,t,r){var a=$('#g'+t+'_spec_mark_'+r).data('specmark-show-student');e.data('specmark-show-student',a),e.find('.cell-corner-2').removeClass('lgray red'),''!=e.data('title2')?e.find('.cell-corner-2').addClass('red'):0==e.data('specmark-show-student')&&e.find('.cell-corner-2').addClass('lgray')}function journalButtonMark(e,t){if(e=e||!1,$('#g'+curgrp+'_dedit, #g'+curgrp+'_cwedit, #user_note_editor').hideClassy(!0),e)$('#g'+curgrp+'_marks_buttons,#g'+curgrp+'_tht').hide(0),$('#g'+curgrp+'_dsel').show(0),$('#g'+curgrp+'_dsel_mb').hide(0),!0!==t&&window.Context.hide(),$('#g'+curgrp+'_marksButtons, #g'+curgrp+'_marks_buttons').find('.selected').removeClass('selected'),window.bmark=!1,window.specMarkId=!1;else if($('#g'+curgrp+'_marks_buttons').filter(':visible').length>0)window.bmark=!1,window.specMarkId=!1,$('#g'+curgrp+'_dsel').show(0),$('#g'+curgrp+'_dsel_mb').hide(0),$('#g'+curgrp+'_tht').hide(0),$('#g'+curgrp+'_marks_buttons').hide(0),$('#g'+curgrp+'_thth3').removeClass('active'),$('#g'+curgrp+'_marks_switcher').removeClass('active'),!0!==t&&window.Context.hide();else{if(curcol&&(journalSaveMarkClk(curgrp,pres,!1,!0),curcol))return!1;$('#g'+curgrp+'_dsel').hide(0),$('#g'+curgrp+'_dsel_mb').show(0),$('#g'+curgrp+'_tht').hide(0),$('#g'+curgrp+'_marks_buttons').show(0),$('#g'+curgrp+'_thth3').removeClass('active'),$('#g'+curgrp+'_marks_switcher').addClass('active'),window.bmark=!0;var r=$('#g'+curgrp+'_marks_buttons, #g'+curgrp+'_marksButtons-content'),a=r.find('.marks_buttons__item.selected');if(0==a.length)r.find('.marks_buttons__item--mark').trigger('click');else{window.bmark=a.data('value');var n=a.data('specmarkid');void 0!==n&&!1!==n?(window.specMarkId=a.data('specmarkid'),window.bmark=window.bmark.toString(),window.bmark=$.trim(window.bmark),window.bmark=window.bmark.toUpperCase()):window.specMarkId=!1}}return journalSelect(),!1}var truemark=!0,bmark=!1,specMarkId=!1;function journalSaveMarkClk(e,t,r,a){if(!window.curcol)return!1;var n=window.curcol,o=$(n);if(n&&null!=o.attr('cw_task_column_id'))return!1;if(n&&null!=o.attr('cw_task_id')){var s=o.attr('cw_task_id'),l=o.attr('cw_id');if(kes[curgrp][l]&&kes[curgrp][l][s]){var i=$.trim($(current_input).val()),d=kes[curgrp][l][s].info.max_mark,c=parseInt(i);if(''!=i&&(isNaN(c)||c<0||c>d))return $(current_input).addClass('red'),!1}}if(a=a||!1,t=t||!1,!(r=r||!1)&&!truemark)return alert(errormsg,!0),!1;journalSelect();var u=n&&n.id&&n.id.indexOf('_avg')>-1,p=n&&n.id&&n.id.indexOf('_part')>-1,h=!(u||p||$('#Grid').is('.grid--one_and_half, .grid--double, .grid--one_and_half_width, .grid--double_width')||o.is('.cells_one_and_half_width, .cells_double_width')),m=o.attr('mt_id'),_=o.attr('max_mark'),f=o.attr('weight');o.children('div.markedit').each((function(){var t,r=$(this),a=r.find('input'),s=a.addClass('for_delete').val();if(n&&null!=o.attr('cw_task_id'))t={miss:!1,mark:s};else{var l=!1;'Экзамен'==a.attr('mpart')||'Внутр. экз.'==a.attr('mpart')?l=!0:'ЕГЭ'==a.attr('mpart')?l='ЕГЭ':'ЕГЭ (б)'==a.attr('mpart')?l='ЕГЭ (б)':'ЕГЭ (п)'==a.attr('mpart')&&(l='ЕГЭ (п)'),t=journalParseMark({mark:s,max_mark:_,weight:f,markTypeId:m,isPartMark:pres||null!=a.attr('mdate')&&a.attr('mdate').indexOf('_pmark')>0||'Годовая'==a,isExam:l},window.JournalConfig,window.allow_marks,window.mtypes[curgrp])}if(t){var i='',d='',c='';t&&t.miss?(r.attr('miss_type','miss'),c=window.miss_symbol_small||'н'):'miss'==r.attr('miss_type')&&r.removeAttr('miss_type'),'late'==r.attr('miss_type')&&(c=window.late_symbol||'ОП'),null!=r.attr('spec_mark')&&(i=r.attr('spec_mark')),isNaN(parseInt(r.attr('max_pmark')))||isNaN(parseInt(t.mark))||(d=(parseInt(r.attr('max_pmark'))>parseInt(t.mark)?Math.round(parseInt(t.mark)/parseInt(r.attr('max_pmark'))*100):100)+'%');var u=null!=t.display?t.display:t.mark;r.removeClass('markedit').html(window.journalMarkTemplate(u,'',i,d,c)).toggleClass('small',h&&isLongMark(u)),r.hasClass('comm')&&r.tooltip({title2:!0}),null!=r.attr('spec_mark')&&updateSpecMarkColor(r,e,r.attr('spec_mark_id'))}else{var p=window.errormsg?window.errormsg:intl.get('You have entered wrong mark')+'.';alert(p)}})),a&&($('#g'+e+'_dedit,#g'+e+'_cwedit').length>0?($('#g'+e+'_dedit,#g'+e+'_cwedit').hideClassy(!0),$('#g'+e+'_dsel').show(),$('#g'+e+'_cw').show()):$('#g'+e+'_econtrol').hide()),window.curcol=!1,window.curel=!1,$('#g'+e+'_journal').find('.cells_editing').removeClass('cells_editing')}var allowplus=1,allow_missmark=1,allow_markmark=1,allow_twomarks=1,max_allow_mark=0,isres=!1;document.onkeydown=journalMarkNav;var maxlnum,longd=2,allow_edit_pmarks=!0,KESMark=!1;function journalMarkNav(e){if(curcol){var t=(e=e||window.event).keyCode?e.keyCode:e.which?e.which:null,r=e.target||e.srcElement;if(!$(r.parentNode).hasClass('markedit')&&(37==t||39==t))return!0;var a=curcol.getElementsByTagName('INPUT');if($(a).each((function(e){$(this).parent().hasClass('trselect')&&(curel=e)})),9===t){var n=!1;try{n=$(curcol).is(':focus-within')}catch(e){}n&&(e.preventDefault(),t=40)}if(curel>=0&&a[curel]&&(37==t||38==t||39==t||40==t)){var o=!1,s=(c=$(a[curel])).attr('mpart');'Экзамен'==s||'Внутр. экз.'==s?o=!0:'ЕГЭ'==s?o='ЕГЭ':'ЕГЭ (б)'==s?o='ЕГЭ (б)':'ЕГЭ (п)'==s&&(o='ЕГЭ (п)');var l=a&&a[curel]&&a[curel].value||'';if(!KESMark&&!journalParseMark({mark:l.toLowerCase().trim(),obj:a&&a[curel]&&a[curel],isPartMark:pres||null!=c.attr('mdate')&&c.attr('mdate').indexOf('_pmark')>0||'Годовая'==s,isExam:o},window.JournalConfig,window.allow_marks,window.mtypes[curgrp]))return c.addClass('red'),!1}var i=1;switch(t){case 13:$(r).trigger('focusout'),journalSaveMarkClk(curgrp,!1,!1,!0);break;case 38:-1==curel&&(curel=1);for(var d=1,c=$(a[curel-d]).parent();curel-d>=0&&(c.hasClass('cell_inactive')||c.hasClass('cell--locked'))&&!c.hasClass('editable');)d++,c=$(a[curel-d]).parent();if((!(c=$(a[curel-d]).parent()).hasClass('cell_inactive')&&!c.hasClass('cell--locked')||c.hasClass('editable'))&&(curel=curel>0?curel-d:0,c=$(a[curel-d]).parent()),_=a[curel]){_.focus(),journalSelect(_.parentNode),setCaretPosition(_,10),journalSelect(_.parentNode),setCaretPosition(_,10);var u=$(document).scrollTop(),p=window.Grid?Grid.fixedHeaderHeight:heightContainer;if(1==window.posMode||window.Grid&&1==window.Grid.posMode){var h=(window.Grid?$('.table_header_fixed'):$('#fixedHeader')).position(),m=$(_).position();h&&h.top&&m&&m.top&&m.top<p+h.top&&$(document).scrollTop(u-Math.max(cell_size,p+h.top-m.top))}else(2==window.posMode||window.Grid&&2==window.Grid.posMode)&&$(document).scrollTop(u-p)}break;case 40:for(d=1,c=$(a[curel+d]).parent();curel+d<=a.length-1&&(c.hasClass('cell_inactive')||c.hasClass('cell--locked'))&&!c.hasClass('editable');)d++,c=$(a[curel+d]).parent();var _;if((!(c=$(a[curel+d]).parent()).hasClass('cell_inactive')&&!c.hasClass('cell--locked')||c.hasClass('editable'))&&(curel=curel<a.length-1?curel+d:curel,c=$(a[curel+d]).parent()),_=a[curel]){if(1==window.posMode||window.Grid&&1==window.Grid.posMode){var f=$(window).height();u=$(document).scrollTop(),p=window.Grid?Grid.fixedHeaderHeight:heightContainer,h=(window.Grid?$('.table_header_fixed').filter(':visible'):$('#fixedHeader')).position();(m=$(_).position())&&m.top&&h&&h.top&&(m.top+cell_size-u>f?$(document).scrollTop(u+Math.max(cell_size,m.top+cell_size-u-f)):m.top<p+h.top&&$(document).scrollTop(u-Math.max(cell_size,p+h.top-m.top)))}_.focus(),journalSelect(_.parentElement),setCaretPosition(_,10)}break;case 37:if(pres&&!allow_edit_pmarks)return;$(r).trigger('focusout');var g=curcol.previousElementSibling,w=0;if(isExpandedCw)for(;g&&($(g).hasClass('cells_skip')||null!=markType&&''!=markType&&0==$(g).filter(markType).length);)g=g.previousElementSibling,$(g).hasClass('cells_skip')&&0==$(g).filter(':visible').length&&w--;else if(null!=markType&&''!=markType)for(;g&&0==$(g).filter(markType).length;)g=g.previousElementSibling,0==$(g).filter(':visible').length&&w--;-1==curel&&(curel=0);var v=a[curel].name;for(i=1;g;){!window.hometask_journal&&!window.cw_codifier_journal||isExpanded||'I'!=g.tagName||(g=g.previousElementSibling);var k=$(g).find('div[name="'+v+'"]');if(null==g||null==g||1==g.nodeType&&(!k.hasClass('cell_inactive')&&!k.hasClass('cell--locked')||k.hasClass('editable')))break;null!=(g=g.previousElementSibling)&&null!=g&&i++}if(null==g||null==g)return;if(window.Grid){var b=$(g).index();window.Grid.getScrollPosition()>b&&window.Grid.scrollTo(b)}else!window.hometask_journal&&!window.cw_codifier_journal||isExpanded||null==g.previousElementSibling||'I'==g.previousElementSibling.tagName||'none'!=g.previousElementSibling.style.display?(!0!==window.hometask_journal&&!0!==window.cw_codifier_journal&&null!=g.previousElementSibling&&'none'==g.previousElementSibling.style.display||'none'==g.style.display)&&journalScrollDirection(w-i):journalScrollDirection(w-i);$(g).hasClass('cells_homework')&&(i=longd),journalMarkNavCaret(i,a,!0,g);break;case 39:if(pres&&!allow_edit_pmarks)return;$(r).trigger('focusout');g=curcol.nextElementSibling,w=0;if(isExpandedCw)for(;g&&($(g).hasClass('cells_skip')||null!=markType&&''!=markType&&0==$(g).filter(markType).length);)g=g.nextElementSibling,$(g).hasClass('cells_skip')&&0==$(g).filter(':visible').length&&w++;else if(null!=markType&&''!=markType)for(;g&&0==$(g).filter(markType).length;)g=g.nextElementSibling,0==$(g).filter(':visible').length&&w++;-1==curel&&(curel=0);for(v=a[curel].name;g;){!window.hometask_journal&&!window.cw_codifier_journal||isExpanded||'I'!=g.tagName||(g=g.nextElementSibling);k=$(g).find('div[name="'+v+'"]');if(null==g||null==g||1==g.nodeType&&(!k.hasClass('cell_inactive')&&!k.hasClass('cell--locked')||k.hasClass('editable')))break;g=g.nextElementSibling,i++}if(null==g||null==g||g&&'DIV'!==g.nodeName){if(curcol=='g'+curgrp+'_pmarks'||curcol=='g'+curgrp+'_yearly')return;if(void 0!==(nct=$('#g'+curgrp+'_pmarks').get(0))&&allow_edit_pmarks&&curcol.parentNode!==nct)g=nct;else{if(!$(g).hasClass('cells_homework'))return;i=longd}}if(window.Grid){b=$(g).index();window.Grid.getScrollPosition()+window.Grid.getScrollStep()<=b&&window.Grid.scrollTo(b)}else'none'==g.style.display&&journalScrollDirection(w+i);journalMarkNavCaret(i,a,!1,g)}13!=t&&37!=t&&38!=t&&39!=t&&40!=t||(e.preventDefault?e.preventDefault():e.returnValue=!1)}}function journalMarkNavCaret(e,t,r,a){var n,o,s=curel;if((n='1'===$(curcol).attr('canedit')?r?$('#g'+curgrp+'_marks > div.cells[canedit="1"]:not(".cells_skip"):not(".backdate") > div.cell.trselect, #g'+curgrp+'_pmarks > div.cells[canedit="1"] > div.cell.trselect').map((function(){return this})):$('#g'+curgrp+'_marks > div.cells[canedit="1"]:not(".cells_skip") > div.cell.trselect, #g'+curgrp+'_pmarks > div.cells[canedit="1"] > div.cell.trselect').map((function(){return this})):r?$('#g'+curgrp+'_marks > div.cells:not(".cells_skip"):not(".backdate") > div.cell.trselect, #g'+curgrp+'_pmarks > div.cell.trselect').map((function(){return this})):$('#g'+curgrp+'_marks > div.cells:not(".cells_skip") > div.cell.trselect, #g'+curgrp+'_pmarks > div.cell.trselect').map((function(){return this}))).length>0){var l=0;n.each((function(e){n[e]!=t[curel].parentNode||(l=e)})),o=r?n[l-e]:n[l+e]}else a&&(o=a.getElementsByTagName('DIV')[1]);if(!o)return!1;r&&(window.hometask_journal||window.cw_codifier_journal)&&0==$(o.parentNode).filter(':visible').length&&journalScrollDown(-(e-1)),journalEditMarkClk(o,pres,$(o.parentNode).attr('column-type'),$(o.parentNode).attr('cw_task_id')),curel=s;var i=curcol.getElementsByTagName('INPUT')[curel];setCaretPosition(i,10),r||(focus_col=l-e-1)}function journalComposeRebuke(e){journalCancelRebuke(),$('[id^=g'+curgrp+'_r__]').removeClass('active'),$('#g'+curgrp+'_r__'+e).addClass('active'),$('[id^=g'+curgrp+'_rebuke__]').hide(),$('#g'+curgrp+'_rebuke__'+e).show(),$('#g'+curgrp+'_rebukefio__'+e).find('option').prop('selected',!1).first().prop('selected',!0).trigger('refresh'),$('#g'+curgrp+'_rebuketext__'+e).trigger('focus').val(''),$('#g'+curgrp+'_with_clteach__'+e).prop('checked',!1),$('#g'+curgrp+'_headteach__'+e).find('option').prop('selected',!1).first().prop('selected',!0).trigger('refresh');var t=$('#g'+curgrp+'_selection_group__'+e);return t.off('update click').on('update',(function(e){0===$(this).find('a.selected').length&&$(this).find('a').first().trigger('click')})).on('click','a',(function(e){e.preventDefault(),$(this).toggleClass('selected'),0===t.find('a.selected').length&&t.find('a').filter('[name!="'+$(this).attr('name')+'"]').trigger('click')})).trigger('update'),!1}function journalShowStatus(e){return $('#g'+curgrp+'_journal div[viewed=yes]').toggleClass('seen'),''!=$(e).attr('alttext')&&(t=$(e).text(),$(e).text($(e).attr('alttext')),$(e).attr('alttext',t)),!1}function journalSendRebuke(e,t){var r=$(t).parents('form');if(0===r.length)return!1;var a=r.get(0),n=$(a.text),o=$(a.fio),s=$(a.date),l=$(a.with_clteach),i=$(a.with_headteach),d=$(a.selection);if(''==$.trim(n.val()))return alert(r.attr('empty_text_message'),!0),!1;var c=o.val(),u=n.val(),p=s.val(),h=l.is(':checked'),m=i.find('option:selected').val(),_='',f='';if(d.length>0){var g=[];$('#g'+curgrp+'_marks  > .cells').length>0?$('#g'+curgrp+'_marks  > .cells:last > .cell').each((function(){$(this).hasClass('transition')&&$(this).hasClass('cell_inactive')||g.push($(this).attr('name'))})):$('#g'+curgrp+'_fio > .cell').each((function(){g.push($(this).attr('name'))})),_=g.join(';');var w=[];d.parent().find('a.selected').each((function(){w.push($(this).attr('name'))})),f=w.join(';')}return JournalTeacher.sendRebuke(e,c,u,p,h,m,_,f),journalCancelRebuke()}function journalCancelRebuke(){if('undefined'==typeof groups)return!1;var e=Object.values(groups);return 0===e.length&&(e=[curgrp]),e.forEach((function(e){var t=String(e);$('[id^="g'+t+'_rebuke__"]').hide(),$('[id^="g'+t+'_r__"]').removeClass('active'),$('[id^="g'+t+'_selection_group__"]').find('a').off('click')})),!1}function journalSubjectTemplate(e){var t=e.topic?e.topic:'',r=intl.get('legacy.study.journal.lesson_by_plan')+': №',a=''==(e.topicNum?e.topicNum:'')?'hidden':'',n=!!e.before&&e.before,o=!!e.after&&e.after,s=!0!==e.disableHeader,l=Number(e.maxlength?e.maxlength:255),i=n?'<div class="journal_subject__body__input__before">'+n+'</div>':'',d=o?'<div class="journal_subject__body__input__after">'+o+'</div>':'';return'<div id="subjectBlock" class="'+('journal_subject'+(n?' journal_subject--before':'')+(o?' journal_subject--after':''))+'">'+(s?'<div class="journal_subject__header"><div id="topicNumByPlan" class="journal_subject__header__label '+a+'">'+r+'<span class="plan_lesson_num">'+e.topicNum+'</span></div><button id="setHomeTaskByPlan" disabled class="journal_subject__header__set button button--compact" onclick="return journalSetPlanHometasks(\'lessons\')">'+intl.get('legacy.study.hometask.by_plan')+' <i class="fa fa-arrow-right"></i></button></div>':'')+'<div class="journal_subject__body"><button id="planl" disabled class="journal_subject__body__button journal_subject__body__button--prev" title=""><i class="fa fa-angle-left"></i></button><div class="journal_subject__body__input">'+i+'<textarea id="subject" class="journal_subject__body__input__value field" maxlength="'+l+'">'+t+'</textarea>'+d+'<p id="subject_counter" class="journal_subject__body__input__counter"> '+window.trans('hometask.available_for_input')+' <span id="subject_counter__wrap"><span id="subject_counter__value">0</span> '+window.trans('hometask.from')+' </span> <span id="maxcounter"></span> '+window.trans('hometask.characters')+'.</p></div><button id="planr" disabled class="journal_subject__body__button journal_subject__body__button--next" title=""><i class="fa fa-angle-right"></i></button></div><div class="spacer"></div></div>'}function getCloudResourcesButtonHtml(e,t){return!0===window.isShowCloudResources?$('<a class="offset6 button button--outline button--small button--blue"></a>').addClass(e).prop('add-cloud-resources-id',t).prop('title',window.trans('system.mail_cloud')).append('<img src="/img/partner/logo/cloud_resources.svg">').tooltip():''}function getSkysmartResourcesButtonHtml(){return!0===window.skysmartEnabled?$('<a class="offset6 button button--outline button--small button--blue offsetRight10 attach-resource modal-resource marks-modal-skysmart"></a>').prop('href','/journal-resources-action/template.clear/lesson_id.'+JournalTeacher.lesson_id+'/#tabs-skysmart').prop('title',window.trans('integrations.tasks_in_Skysmart')).prop('onclick',$('.marks-modal-skysmart').attr('referer','action-resource')).append('<img src="/img/partner/logo/skysmart_logo_button_ht.png">').tooltip():''}function getYaclassResourcesButtonHtml(){return!0===window.yaclassEnabled?$('<a class="offset6 button button--outline button--small button--blue offsetRight10 attach-resource modal-resource marks-modal-yaklass"></a>').prop('href','/journal-resources-action/template.clear/lesson_id.'+JournalTeacher.lesson_id+'/#tabs-yaklass').prop('title',window.trans('integrations.test_works_by_yaklass')).prop('onclick',$('.marks-modal-yaklass').attr('referer','action-resource')).append('<img src="/img/partner/logo/yaklass_logo_button_ht.png">').tooltip():''}function journalFill(e){var t=$('#subjectBlock');if(t.length>0&&(journalSetHometask(t.get(0).parentNode.parentNode),$('#subjectBlock').length>0))return!1;$(e).find('span.hometaskItem a').show(),$(e).find('.editIndHT').show(),$(e).removeClass('trLes').addClass('trEditHT');var r=$(e).attr('ldate');window.parameters_date=r;var a=$(e).find('td').get(0).innerText,n=$(e).attr('num'),o=$(e).find('.tdHT'),s=$(e).find('.tdTopic'),l=s.find('a'),i=[],d=[];l.each((function(e,t){$(t).children().length>0?i.push(t):d.push(t)}));var c='';i.length&&$(i).each((function(e,t){var r=t.href,a=r.replace(/.*\/(.*)\?filename=.*/,'$1'),n=''!==t.title?t.title:t.text,o=-1!==n.indexOf('.')?n.replace(/.*[.]/,''):'';''!==o&&(c+='<div class="minispacer"></div><nobr id="fid'+a+'" fid="'+a+'" url="'+r+'"><input type="checkbox" name="resources[]" checked value="'+a+'"> <img class="attach '+(exttoclass[o]?exttoclass[o]:'att')+'" src="/img/html-default/spacer.gif"> <span><a  target="_blank" href="'+r+'" title="'+n+'" class="lblue notd">'+n+'</a></span></nobr>')}));var u=' ';d.length&&$(d).each((function(e,t){var r=t.href,a=$(t).attr('data-id'),n=$(t).attr('data-hash'),o=$(t).attr('data-title'),s=0===n.indexOf('ya_');u+='<div class="minispacer"></div><label data-id="'+a+'" data-hash="'+n+'" data-title="'+o+'" title="'+o+'"><input type="checkbox" checked value="'+a+'" name="resources[]"> <i class="'+(s?'resource-icon-yaclass':'blue fa fa-link lh16')+'"></i> <a href="'+r+'" target="_blank">'+o+'</a></label>'})),s.find('span.cw-text').remove();var p=s.find('.fill').length>0?'':$.trim(s.text()),h=Number(window.maxlength_subject?window.maxlength_subject:255);s.html(journalSubjectTemplate({topic:p,topicNum:'',before:s.attr('cwtxt1'),after:s.attr('cwtxt4'),maxlength:h}));var m='upload_'+Math.floor(9999999*Math.random()+1e6);$('#subjectBlock').append($('<table class="sTable"></table>').append($('<tbody></tbody>').append($('<tr></tr>').append($('<td></td>').css({'text-align':'left'}).append($('<a title="'+attach_resource+'" class="attach-resource button button--outline button--small button--red" href="/journal-resources-modal-action/lesson_id.'+JournalTeacher.lesson_id+'/"><i class="fa fa-paperclip"></i> '+resource_txt+'</a>')).css({'text-align':'left','padding-left':'32px'}).append(getSkysmartResourcesButtonHtml()).append(getYaclassResourcesButtonHtml()).append($('<div name="sjfiles" id="subject_attachments"></div>').addClass('attaching attaching--ht').css({'text-align':'left','padding-left':'15px'}).append($('<div class="attaching__caption"></div>').append($('<a class="attach-file button button--outline button--small button--red" href="#"><i class="fa fa-paperclip"></i> '+attach_file_txt+'</a>').attr('id',m).attr('title',attach_label)).append(getCloudResourcesButtonHtml('add-cloud-resources-in-subjects-btn',m))).append(c)).append($('<div class="journal-resource-files subject_resources"></div>').css({'text-align':'left','padding-left':'15px'}).append(u))).append($('<td td="sjattach_submit"></td>').css({'text-align':'right','vertical-align':'top','padding-left':'10px','width':34}).append('<input type="submit" class="submit button button--red button--small" name="okBtn" onclick="return journalSetHometask(this.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode);" value="OK"/>')))));var _={};$((function(){new AjaxUpload(m,{action:storage.upload,name:'userfile',autoSubmit:!0,responseType:'json',onSubmit:function(e,t){var r=this._button.parentNode.parentNode.parentNode,a=$(r).find('#subject_attachments');if(a){a=$(a);var n=['<nobr id="',hex_md5(e),'">','<input type="checkbox" disabled /> ','<img src="/img/html-default/spacer.gif" alt="" class="attach ',exttoclass[t]?exttoclass[t]:'att','" />','&nbsp;<span>',loading_label||'Загрузка','</span>','</nobr>'];a.append(n.join(''))}return!0},onComplete:function(t,o){_.file=o.file,_.filename=o.name;var l=$('#subject').val();l=l==$('#subject').attr('placeholder')||''===l?seefiles_txt:l,(s.attr('cwtxt1')||s.attr('cwtxt2')||s.attr('cwtxt3')||s.attr('cwtxt4'))&&(l=s.attr('cwtxt1')+s.attr('cwtxt2')+l+s.attr('cwtxt3')+' '+s.attr('cwtxt4'));var i=getPidOfLesson($(e));return JournalTeacher.saveLessonTopic(a,r,l,n,i,[_],[],!0),journalUploadResponse(this._button.parentNode.parentNode.parentNode,t,o)}})})),$('#planl').on('click',(function(t){return t.preventDefault(),journalSubject(e,-1,$(e).attr('lnum'))})),$('#planr').on('click',(function(t){return t.preventDefault(),journalSubject(e,1,$(e).attr('lnum'))})),$('#subject').attr('placeholder',subject_ph).off('change keypress keydown').on('change keypress keydown',(function(e){var t=e.keyCode?e.keyCode:e.which?e.which:null;37!==t&&38!==t&&39!==t&&40!==t&&$(this).attr('needsave','yes')})).off('focusout').on('focusout',(function(){if(null!=$(this).attr('needsave')&&'no'!=$(this).attr('needsave')||s.attr('cwtxt1')){$(this).val(ucfirst($(this).val()));var t=$(this).val();t=t==$(this).attr('placeholder')?'':t,(s.attr('cwtxt1')||s.attr('cwtxt2')||s.attr('cwtxt3')||s.attr('cwtxt4'))&&(t=s.attr('cwtxt1')+s.attr('cwtxt2')+t+s.attr('cwtxt3')+' '+s.attr('cwtxt4')),$(this).attr('needsave','no');var o=getPidOfLesson($(e));JournalTeacher.saveLessonTopic(a,r,t,n,o)}})),controlDeletingOfPlanSubject($(e)),journalSubject(e,0,$(e).attr('lnum')),setCaretPosition($('#subject').get(0),$('#subject').val().length),o.find('p').length>0?lhtt=$('<table id="newht" class="newht"><tbody></tbody></table>').insertBefore(o.find('p')):lhtt=$('<table id="newht" class="newht"><tbody></tbody></table>').appendTo(o),$('<tr></tr>').appendTo(lhtt).append($('<td id="ht_date"></td>').css('width','0px').attr('rowSpan','2')).append($('<td></td>').css('width','27px')).append($('<td></td><td id="btnSpace"></td>'));var f=$('<select name="htdate" class="select hometask-lessons__input-date__select"></select>'),g=!1,w=0,v=[];$(ndate[curgrp]).each((function(){var e=this.toString();e!=r?!g||w>=ndate_count||(w++,e?(v.push(e),$('<option></option>').val(e).html(e.replace(/(....)-(..)-(..).*/,'$3.$2')).appendTo(f)):$('<option></option>').val(e).html(toholiday_label).appendTo(f)):g=!0}));var k=$('<div class="journal_hometask__header '+(JournalLessonOptions.ht_minutes?'':' hide')+'"></div>').append($('<button class="journal_hometask__daily button button--compact">'+intl.get('legacy.study.report.hw_load')+'</button>'));k.on('click','.journal_hometask__daily',(function(){if($('#hometaskDailyContext.context--visible').length>0)Context.hide({id:'hometaskDailyContext'});else{var e=this,t='class='+JournalTeacher.cls+'&dates='+implode(';',v)+'&grp='+JournalTeacher.grp+'&sp='+JournalTeacher.sp+'&isParticular=true';$.getJSON('/journal-study-monitor-homework-load-action/?'+t,(function(t){var r=hometaskDailyTemplate(t);Context.show(e,{id:'hometaskDailyContext',noScroll:!1,html:r})}))}return!1})),o.prepend(k),0===$(f).find('option').length&&$(f).html('<option value="">'+toholiday_label+'</option>');var b='upload_'+Math.floor(9999999*Math.random()+1e6);f.attr('selectedIndex','0');var y=window.isHometaskEmailingEnabled?$('<div class="hometask-lessons__files"></div>').append('<ej-switcher id="mailSwitch" name="email_switch" class="hometask-lessons__files" size="small" label="'+window.trans('hometask.send_homework_by_email')+'"></ej-switcher>'):'',C=collectingFilesEnabled?$('<div class="hometask-lessons__files"></div>').append('<ej-switcher id="hlfs1" name="files_switch" class="hometask-lessons__files-switch" size="small" label="'+window.trans('hometask.get_execution_result')+'"></ej-switcher>').append('<input id="hlfc1" name="files_comment" type="text" class="hometask-lessons__files-comment field field--small hide" name="comment" maxlength="150" placeholder="'+window.trans('hometask.file_collection_comment')+'" />').append('<button class="collecting-files-info offset10 button button--gray button--outline button--icon button--round button--tiny"><i class="fas fa-question"></i></button>'):'';return $('<tr name="hometask"></tr>').appendTo(lhtt).append($('<td class="hometask_button"></td>').css({'vertical-align':'top','width':32}).append($('<a class="button button--blue button--left button--icon" onclick="return journalAddHometask (this.parentNode.parentNode);">+</a>').attr('title',titleadd))).append($('<td></td>').css({'text-align':'left'}).append($('<div class="hometask-container hometask-lessons"></div>').append($('<div class="hometask-lessons__input"></div>').append('<div id="ub1" class="user_buttons">'+hometask_buttons+'</div>').append($('<textarea class="hometask-lessons__input-field input field" id="ubel1" name="task" maxlength="'+h+'" /></textarea>').attr('placeholder',hometask_ph)).append($('<div class="hometask-lessons__input-date date"><span>'+to+'&nbsp;</span></div>').append(f))).append('<div class="hometask-lessons__minutes'+(JournalLessonOptions.ht_minutes?'':' hide')+'"><span class="control-label"><i class="fa gray fa-clock" title="Время на выполнение ДЗ"></i></span><input type="text" class="field hometask-lessons__minutes-input" name="htminutes" maxlength="3" '+(JournalLessonOptions.ht_minutes&&JournalLessonOptions.ht_minutes_required?'required="true"':'')+'><span class="control-label hometask-lessons__minutes-title'+(JournalLessonOptions.ht_minutes?'':' hide')+'">'+trans('system.min')+'</span></div>').append($('<div class="hometask-lessons__attach"></div>').append(y).append(C).append('<div class="clear minispacer"></div>').append($('<a class="attach-resource button button--outline button--small button--red" href="/journal-resources-modal-action/lesson_id.'+JournalTeacher.lesson_id+'/"><i class="fa fa-paperclip"></i> '+resource_txt+'</a>').attr('title',attach_resource)).append(getSkysmartResourcesButtonHtml()).append(getYaclassResourcesButtonHtml()).append($('<div name="htfiles"></div>').addClass('attaching attaching--ht').append($('<div class="attaching__caption"></div>').append($('<a class="attach-file button button--outline button--small button--red" href="#"><i class="fa fa-paperclip"></i> '+attach_file_txt+'</a>').attr('id',b).attr('title',attach_label)).append(getCloudResourcesButtonHtml('add-cloud-resources-in-tasks-btn',m)))).append('<div class="journal-resource-files"></div>')))).append($('<td id="ht_submit"></td>').css({'text-align':'center','vertical-align':'top','width':34}).attr('rowSpan','2').append('<input type="submit" class="submit button button--red" name="okBtn" onclick="return journalSetHometask(this.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode);" value="OK"/>')),journalUserButtons('1'),$((function(){new AjaxUpload(b,{action:storage.upload,name:'userfile',autoSubmit:!0,responseType:'json',onSubmit:function(e,t){return journalUploadSubmit(this._button.parentNode.parentNode,e,t)},onComplete:function(e,t){return journalUploadResponse(this._button.parentNode.parentNode,e,t)}}),window.isShowCloudResources&&(window.addCloudResourceEvent($('.add-cloud-resources-in-tasks-btn'),'add-cloud-resources-id',(function(e){return $('.hometask-container.hometask-lessons').find('.journal-resource-files')})),window.addCloudResourceEvent($('.add-cloud-resources-in-subjects-btn'),'add-cloud-resources-id',(function(e){return $('.subject_resources')})))})),initTopicCounter(),!1}function initTopicCounter(){var e={maxCounter:Number(window.maxlength_subject?window.maxlength_subject:255),hideSectionCounter:function(e,t,r){e.toggleClass('hide',t===r)},colorCounter:function(e,t){e.toggleClass('counter--warning',t<50&&t>10),e.toggleClass('counter--danger',t<=10)},setCounter:function(e,t,r,a,n){a.html(this.maxCounter);var o=this.maxCounter-Number(e.val().length);n.html(o),this.colorCounter(t,o,this.maxCounter),this.hideSectionCounter(r,o,this.maxCounter)}},t=$('#subject'),r=$('#maxcounter'),a=$('#subject_counter'),n=$('#subject_counter__wrap'),o=$('#subject_counter__value');e.setCounter(t,a,n,r,o),t.on('input keypress',(function(){e.setCounter(t,a,n,r,o)}))}function journalSubject(e,t,r){$lessonRow=$(e),$lessonRow.find('#subject').removeData('plan_topic');var a=$lessonRow.find('#subject').val(),n=getPidOfLesson($lessonRow);return planHometasks=null,window.isSetPlanForGroup[JournalTeacher.grp]?(0==t&&''!=a&&''==n||JournalTeacher.getLessonTopic(n,t,r,$lessonRow),!1):($lessonRow.find('#planl, #planr').prop('disabled',!0),!1)}function journalSetPlanHometasks(e){if(-1==['lessons','hometaskAdd'].indexOf(e))return!1;if('undefined'!=typeof planHometasks&&null!=planHometasks)for(taskid in planHometasks){switch(e){case'lessons':var t=(o=$('tr[name="hometask"]:last')).find('.hometask-lessons__input-field'),r=o.find('.hometask-lessons__minutes-input'),a=o.find('.journal-resource-files'),n=o.find('div[name="htfiles"]');break;case'hometaskAdd':var o,s=HometaskAddData.currentLesson.num;t=(o=$('tr[name="hometask"][data-num="'+s+'"]:last')).find('.hometask-add-text'),r=o.find('input[name="htminutes"]'),a=o.find('.modal-resource-files'),n=o.find('div[name="htfiles"]')}t.val(planHometasks[taskid].task).removeClass('placeholder'),r.val(planHometasks[taskid].minutes);var l=planHometasks[taskid].resources;for(id in l)0==a.children('label[data-id="'+id+'"]').length&&a.append(templateResourcesFile(id,l[id].hash,l[id].title));var i=planHometasks[taskid].files;for(id in i){var d=i[id].filename,c=i[id].fid,u=i[id].url,p=-1!==d.indexOf('.')?d.replace(/.*[.]/,''):'';n.find('br').length>0&&n.append('<br/>');$('<nobr></nobr>').attr('id','fid_'+c).attr('filename',d).attr('fid',c).attr('url',u).append($('<input type="checkbox"/>').attr('checked',!0)).append($('<img/>').attr('src','/img/html-default/spacer.gif').attr('alt','').addClass('attach').addClass(exttoclass[p]?exttoclass[p]:'att')).append('&nbsp;').append($('<span></span>').html('<a class="lblue notd" target="_blank" href="'+u+'">'+d+'</a>')).appendTo(n)}journalAddHometask(o[0])}else alert(intl.get('legacy.study.hometask.no_ht_lesson'));planHometasks=null}function journalShowStudents(e,t,r){t=t||'',r=r||!1;var a=journalStudentProgress($(e).parent().attr('name'),$(e).attr('name'),r);return $('#fios'+t).append(a),!1}function journalStudentProgress(e,t,r,a){var n;a=a||!1,void 0!==hint[r]&&null!=hint[r]&&(n='<h5 class="context__title">'+hint[r]+':</h5>');var o=window.stdm;if(o&&null!=o[e]&&null!=o[e][t]&&null!=o[e][t][r]&&o[e][t][r].length>0){var s=o[e][t][r].length,l=null!=hint.mode&&'print'===hint.mode?'':'list-overflow';n+=s<2?'<ol class="list-delimeter '+l+'">':'<ol class="list-delimeter list-numbered '+l+'">';for(var i=0;i<s;i++)o[e][t][r][i].isnew?n+='<li class="green">':o[e][t][r][i].notstay?n+='<li class="red">':n+='<li>',null!=stlsn&&null!=stlsn[e]&&null!=stlsn[e][t]&&null!=stlsn[e][t][r]&&null!=stlsn[e][t][r][o[e][t][r][i].username]?(n+=o[e][t][r][i].fio,a&&(n+='<br><span class="small">'),n+=' ('+stlsn[e][t][r][o[e][t][r][i].username].join(', ')+')',a&&(n+='</span>')):n+=o[e][t][r][i].fio,n+='</li>';n+='</ol>'}else n+='<span class="text">'+hint.nobody+'</span>';return n}var assoc_id=!1;function journalPrevMarksBoxy(e){if(null==e||!(e instanceof Array)||0==e.length)return'<div class="container">'+trans('confirm.no_marks')+'.</div>';var t=['<div class="container">','<div class="columns columns--gutter columns--gutter-small text-left">'],r=e.length,a=[];if(r>3){var n=r>3?Math.ceil(r/3):1;a=[e.slice(0,n),e.slice(n,2*n),e.slice(2*n,r)]}else a=[e];return a.forEach((function(e){t.push('<div class="column-33">'),e.forEach((function(e){var r=e.mdate.replace(/(....)-(..)-(..).*/,'$3.$2'),a='';''!==e.color&&(a=' style="color: '+e.color+'"'),t.push('<p',a,'>','<span class="font-mono">','<span class="lgray">',r,'</span> ','<span class="strong">',e.mark,'</span>'),''!==e.weight&&e.weight>1&&t.push('<span class="small opacity50">&#215;',e.weight,'</span>'),t.push('</span>'),e.mtype&&e.mtype_short&&''!==e.mtype&&''!==e.mtype_short&&t.push(' <span class="small" title="',e.mtype,'">',e.mtype_short,'</span>'),t.push('</p>')})),t.push('</div>')})),t.push('</div>','</div>'),t.join('')}function journalPrevMarksShow(e,t,r,a,n){boxy[e][t]=!0,new Boxy(r,{title:a,closeText:intl.get('Close'),afterShow:function(){n instanceof Function&&n()},afterHide:function(){boxy[e][t]=!1},draggable:!0,enableBackdrop:!1})}function hometaskSavePresets(){checked=[],unchecked=[],preset_arr=[],task_arr=[],remove_task_arr=[],checkedResources=[],$('#tabs_presets .preset').each((function(){var e=$(this).find('input[id^=ubeli]'),t=$(this).find('input[checked]').length;if(''!=e.val()&&e.val()!=e.attr('placeholder')||0!=t){var r=$(this).attr('preset_num');task=$('#ubeli'+r).val()==$('#ubeli'+r).attr('placeholder')?'':$('#ubeli'+r).val(),task=''==task?seefiles_txt:task;var a=$('#htiminutes_'+r).val();null==a&&(a=0),preset_arr[preset_arr.length]={'preset_id':$(this).attr('preset_id'),'preset_num':r,'content':task,'to_date':window.hometaskIndividualController.date,'minutes':a,'send_email':!0===$(this).find('[name=email_switch]').prop('checked')}}else'null'!==$(this).attr('preset_id')&&JournalTeacher.deleteHometaskPreset($(this).attr('preset_id'))})),$('#ht_students > div > div.hometask_student').each((function(){appended_presets_arr=[],deleted_presets_arr=[],cur_username=$(this).attr('username'),$(this).find('.ht_preset_container a.selected').each((function(){appended_presets_arr[appended_presets_arr.length]={'preset_id':$(this).attr('preset_id'),'preset_num':$(this).attr('preset_num')}})),task_arr[task_arr.length]={'username':cur_username,'presets':appended_presets_arr}})),$('#tabs_presets > .preset').each((function(e){$(this).find('nobr').each((function(e){$(this).children('input').prop('checked')?checked[checked.length]={'id':$(this).attr('fid')?$(this).attr('id').substr(4):'','fid':$(this).attr('fid')?$(this).attr('fid'):$(this).attr('id').substr(4),'url':$(this).attr('url'),'filename':$(this).attr('filename'),'preset_id':$(this).closest('.preset').attr('preset_id'),'preset_num':$(this).closest('.preset').attr('preset_num')}:$(this).attr('fid')&&(unchecked[unchecked.length]={'id':$(this).attr('id').substr(4),'preset_id':$(this).closest('.preset').attr('preset_id')})})),$(this).find('.journal-resource-files input[type=checkbox]:checked').each((function(){checkedResources[checkedResources.length]={'id':$(this).val(),'preset_id':$(this).closest('.preset').attr('preset_id'),'preset_num':$(this).closest('.preset').attr('preset_num')}}))}));var e=$('#lesnum').get(0);lesson_num=e?e.value:parameters_lesnum,JournalTeacher.saveLessonHometaskIndividual(parameters_grp,parameters_class,parameters_lesson_id,parameters_date,lesson_num,preset_arr,task_arr,checked,unchecked,checkedResources)}function hometaskSaveEnabled(){return $('#tabs-individual .selected').length>0}var prepart=!1;function getCwArray(e,t){var r=0,a=0,n=0,o=[],s=0,l=0,i=0;o['-']=0,e=e.replace(/(.*)-sel/,'$1');var d=$('#'+e+' > div.cell:not(.transition)');d.each((function(){var e=$(this).find('.cell-data').length>0?$(this).find('.cell-data').text().trim():$(this).text().trim();e=e||$(this).find('input').val();var t='miss'===$(this).attr('miss_type');if(null!=e&&0!=e.length||(e=$('input',$(this)).val()),null==e||0==e.length)return o['-']++,!0;var i=e.indexOf('/');if(i>-1){var d=e.substr(0,i),c=e.substr(i+1);e=[d.replace(/[\-\+]/g,''),c.replace(/[\-\+]/g,'')]}else e=[e.replace(/[\-\+]/g,'')];for(var u in e){var p,h=e[u];r++;var m=window.miss_symbol_small||'н';function _(e){return isTen||isPercent?e.length?cwWithoutCorrections&&t?cwWithMiss?e:m:t?m:e:e:e.length>1?cwWithoutCorrections?cwWithMiss&&e.charAt(0).toLowerCase()===m?e.charAt(e.length-1):e.charAt(0):e.charAt(e.length-1):e.length&&t?cwWithoutCorrections?cwWithMiss?e:m:t?m:e:e}p=(p=_(h)).toLowerCase()===m?m:p,null==o[p]?o[p]=1:o[p]++,isPercent?(parseInt(h)>=50&&s++,parseInt(h)>=75&&l++):isTen||(parseInt(p)>2&&s++,parseInt(p)>3&&l++),isNaN(parseInt(p))||(a+=parseInt(p),n++)}}));var c=[],u=0;for(var p in n>0&&(u=Math.roundToSign(a/n,2)),count_all=d.length,null==o[window.miss_symbol_small||'н']&&(null!=o[window.miss_symbol_small||'н']?o[window.miss_symbol_small||'н']=o[window.miss_symbol_small||'н']:o[window.miss_symbol_small||'н']=0),null==o['-']&&(o['-']=0),r=cwPercentFromAll?r+o['-']:r-o[window.miss_symbol_small||'н'],c.push(count_all-o[window.miss_symbol_small||'н']-o['-']),t)if(!isNaN(parseInt(t[p]))||t[p]==(window.miss_symbol_small||'н')||'осв'==t[p]){if(null==o[t[p]]&&(o[t[p]]=0),!isNaN(parseInt(t[p])))if(isPercent)i+=parseInt(t[p])*parseInt(o[t[p]]);else if(isTen)i+=parseInt(t[p])*parseInt(o[t[p]]);else switch(parseInt(t[p])){case 5:i+=100*parseInt(o[t[p]]);break;case 4:i+=64*parseInt(o[t[p]]);break;case 3:i+=36*parseInt(o[t[p]]);break;case 2:i+=16*parseInt(o[t[p]]);break;default:i+=7*parseInt(o[t[p]])}r>0?c.push([o[t[p]],(t[p]==(window.miss_symbol_small||'н')?Math.round(o[t[p]]/count_all*100):Math.round(o[t[p]]/r*100))+'%']):c.push([o[t[p]],'0%'])}return count_all>0?c.push([o['-'],Math.round(o['-']/count_all*100)+'%']):c.push([o['-'],'0%']),c.push(u),isPercent?r>0?(i=Math.round(i/(10*r)),c.push(i*i+'%')):c.push('0%'):isTen?r>0?(i=Math.round(i/r),c.push(i*i+'%')):c.push('0%'):r>0?(c.push(Math.round(s/r*100)+'%'),c.push(Math.round(l/r*100)+'%'),c.push(Math.round(i/r)+'%')):(c.push('0%'),c.push('0%'),c.push('0%')),c}function getCwHtml(e){var t='',r={datasets:[{label:'Кол-во отметок',data:[]}],labels:cwAllowNumericMarks},a=[],n=cwWithoutCorrections?cwCellsNoCorrection[e]:cwCells[e];for(var o in n){var s=n[o];t+='<div class="cell" name="'+o+'">',jQuery.isArray(s)?(t+='<div class="cell-data-pair"><div class="cell-data-pair__value">'+s[0]+'</div><div class="cell-data-pair__percent">'+s[1]+'</div></div>',a.length<r.labels.length&&a.push(s[0])):t+=s,t+='</div>'}return a.reverse(),r.datasets[0].data=a,void 0!==window.cwLineChartComponent&&(window.cwLineChartComponent.chartdata=r),t}function calcAverageCW(){var e,t,r=[],a=$('#cw-analyse-header-inside > div.cells'),n=a.length;if(0==n)return $('#cw-analyse-average > div.cell,#cw-analyse-delta > div.cell').each((function(){$(this).html('<span class="lgray">0</span>')})),!1;var o=cwWithoutCorrections?cwCellsNoCorrection[currentColumnKey]:cwCells[currentColumnKey],s=isTen?4:6,l=o.length-s,i=l+1;a.each((function(){var e=$(this).attr('columnId'),t=cwWithoutCorrections?cwCellsNoCorrection[e]:cwCells[e];$.each(t,(function(e,a){e<t.length-s+2&&(jQuery.isArray(a)?null==r[e]?r.push(parseFloat(a[0])):r[e]+=parseFloat(a[0]):null==r[e]?r.push(parseFloat(a)):r[e]+=parseFloat(a))}))})),t=(r[0]+r[l]+r[i])/n,e=(cwPercentFromAll?r[0]+r[l]+r[i]:r[0])/n;var d=0,c=0,u=0,p=0,h=0;for(var m in r){var _=Math.roundToSign(r[m]/n,1),f=_;if(_=parseFloat(_),r[m]=0==m?_:e>0?[f,(m==l||m==i?Math.round(_/t*100):Math.round(_/e*100))+'%']:[_,'0%'],isTen)m>0&&m<11&&(u+=_*(11-m),p+=_*m,h+=_);else{switch(parseInt(m)){case 1:d+=_,c+=_,u+=100*_;break;case 2:d+=_,c+=_,u+=64*_;break;case 3:d+=_,u+=36*_;break;case 4:u+=16*_;break;case 5:u+=7*_}m>0&&m<l&&(p+=_*(6-m),h+=_)}}h>0?r.push(Math.roundToSign(p/h,2)):r.push('0'),isTen?e>0?(u=Math.round(u/e),r.push(u*u+'%')):r.push('0%'):e>0?(r.push(Math.round(d/e*100)+'%'),r.push(Math.round(c/e*100)+'%'),r.push(Math.round(u/e)+'%')):(r.push('0%'),r.push('0%'),r.push('0%')),cwWithoutCorrections?cwCellsNoCorrection.average=r:cwCells.average=r,$('#cw-analyse-average').html(getCwHtml('average')).colorizetable();var g=cwWithoutCorrections?cwCellsNoCorrection:cwCells;$('#cw-analyse-delta > div.cell').each((function(e){var t,a,n,o,s='';jQuery.isArray(r[e])?(t=r[e][0],a=r[e][1]):(t=r[e],0!=e&&(s='%')),jQuery.isArray(g[currentColumnKey][e])?(n=g[currentColumnKey][e][0],o=g[currentColumnKey][e][1]):n=g[currentColumnKey][e];var l,i='',d='';((l=Math.round(parseFloat(n)-parseFloat(t)))<0?d='red':l>0&&(d='green'),jQuery.isArray(g[currentColumnKey][e]))?i+='<div class="cell-data-pair"><div class="cell-data-pair__value '+d+'">'+l+'</div><div class="cell-data-pair__percent '+d+'">'+Math.round(parseFloat(o)-parseFloat(a))+'%</div></div>':i+='<span class="'+d+'">'+l+s+'</span>';$(this).html(i)}))}function cwCalcRate(e){return $(e).each((function(){var e=0;$(this).find('input.cwh').each((function(){var t=parseInt($(this).val());isNaN(t)||(e+=t)})),e=e>0?e:'',$(this).find('td.sum').text(e)})),!0}function isLongMark(e){return null!=e&&((e=e.toString()).length>3||e.length>=3&&(!e[0].match(/[0-9]/)||!e[2].match(/[0-9]/))||e==teacherConfig.markDismissed||-1!=allow_marks.indexOf(e)&&e.length>=3)}function isLate(){return $('#g'+curgrp+'_late').hasClass('active')}function todoLoadCounterUpdate(e){var t=journal_load_ids[e];'undefined'!=typeof loadTodoList&&void 0!==loadTodoList[t]&&loadTodoList[t].length>0?$('.todo-counter[data-todo-count-grpid="'+e+'"]').removeClass('hide').text(loadTodoList[t].length):$('[data-todo-count-grpid="'+e+'"]').hasClass('hide')||$('.todo-counter[data-todo-count-grpid="'+e+'"]').addClass('hide').text('')}function hometaskDailyTemplate(e){var t;if($.isEmptyObject(e))t='<div class="page-empty">'+intl.get('legacy.error.no_future_dates_ht')+'</div>';else{for(dayDate in t='<div style="height: 360px;" class="ej-scrollable"><table class="ej-table ej-table--colored-lines">',e){var r=e[dayDate].min;for(lesNum in t+='<thead><tr><td colspan="2">'+dayDate+'</td><td>'+r+' '+intl.get('min')+'. </td></tr></thead>',t+='<tbody>',e[dayDate])'min'!==lesNum&&(t+='<tr><td class="ej-table-num">'+lesNum+'</td><td>'+e[dayDate][lesNum].lesson+'</td><td>'+e[dayDate][lesNum].minutes+'</td></tr>');t+='</tbody>'}t+='</table></div>'}return t}function isSafeToSetMark(e){var t=e.attr('spec_mark_transform');return!((t=void 0!==t&&t)&&window.JournalConfig&&void 0!==window.JournalConfig.replaceMarksWithSpecmarks&&window.JournalConfig.replaceMarksWithSpecmarks)}function setPidOfLesson(e,t){'undefined'!=typeof HometaskAddData?HometaskAddData.lessonsPids[HometaskAddData.currentLesson.num]=e:t.attr('pid',e)}function getPidOfLesson(e){if($((function(){$(document).off('click','.hometask-lessons__files-switch').on('click','.hometask-lessons__files-switch',(function(){var e=this,t=$(e).prop('checked');function r(t,r){var a=t===r?'':window.trans('hometask.get_execution_result');$(e).prop('label',a),$(e).prop('checked',t===r),$(e).next().toggleClass('hide',t!==r)}Boxy.confirm(window.trans(t?'hometask.enable_file_collection':'hometask.disable_file_collection')).then((function(){r(t,!0)}),(function(){r(t,!1)}))})),$(document).on('click','.collecting-files-info',(function(e){e.preventDefault();var t=['<div class="typography typography--small">','<p>'+window.trans('hometask.inform.help1')+'</p>','<p>'+window.trans('hometask.inform.help2')+'</p>','</div>'];Context.show(this,{html:t.join(''),isFixed:window.Grid&&1===window.Grid.posMode,color:'yellow',notHideOnOutsideClick:!1,alignHorizontal:'left',alignVertical:'bottom',isInGrid:!0,width:350})}))})),'undefined'!=typeof HometaskAddData){var t=HometaskAddData.lessonsPids[HometaskAddData.currentLesson.num];return void 0===t?'':t}return e.attr('pid')}function clearPlanBindForLesson(e){setPidOfLesson('',e),e.find('#topicNumByPlan').addClass('hidden'),e.find('#planr, #planl').prop('disabled',!0),e.find('#setHomeTaskByPlan').prop('disabled',!0),e.find('#subject').removeData('plan_topic'),planHometasks=null}function controlDeletingOfPlanSubject(e){e.find('#subject').on('change keyup',(function(){var t=$(this).data('plan_topic');if(null==t||''===t)return!1;t=t.substr(1,6).toLowerCase();var r=$(this).val().toLowerCase();''!=r&&-1!==r.indexOf(t)||clearPlanBindForLesson(e)}))}function blockSubjectTextareaWithLoading(e){$('<i class=\'fa fa-spin fa-circle-notch journal_subject__body__input__loading_icon\'></i>').insertBefore(e),e.addClass('disabled')}function removeBlockSubjectTextarea(e){e.siblings('.journal_subject__body__input__loading_icon').remove(),e.removeClass('disabled')}window.journalGetTodayHomeTask=function(e,t){var r=$('#g'+e+'_todayHometask-content');'yes'!==r.attr('loaded')&&(r.html('<div class="page-loading">'+window.trans('action.loading')+'...</div>'),jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.get_partial_content_today_hometask',{'year':JournalTeacher.year,'class':JournalTeacher.cls,'lesson_id':JournalTeacher.lesson_id,'group_id':e,'date':t},JournalTeacher.url),(function(e){void 0!==e.html&&(e.html=htmlspecialchars_decode(e.html)),in_array(e.error,[void 0,''])?r.attr('loaded','yes').html(e.html):JournalTeacher.error(e.error)})))},window.journalGetClassInfo=function(e,t){var r=$('#classTeacherInfo-content');'yes'!==r.attr('loaded')&&(r.html('<div class="page-loading">'+window.trans('action.loading')+'...</div>'),jrpc.post(window.theOnlyWayToGenerateUrlForMethodCall('teacher.get_partial_content_get_class_info',{year:e,'class':t},JournalTeacher.url),(function(e){void 0!==e.html&&(e.html=htmlspecialchars_decode(e.html)),in_array(e.error,[void 0,''])?r.attr('loaded','yes').html(e.html):JournalTeacher.error(e.error)})))};var MarksHighlighting={highlightAllCommonCells:function(){var e=this;$('.cells.cells_marks .cell').each((function(){e.highlightCell($(this),{})}))},currentMode:function(){return null!=window.JournalConfig&&null!=window.JournalConfig.marks_highlight?window.JournalConfig.marks_highlight:'normal'},highlightCell:function(e,t){switch(t=t||{},mode=this.currentMode(),e.attr('class',(function(e,t){return t.replace(/(^|\s)(cell--target-\S+|notsave|saved|saving)/g,'')})),mode){case'isp':this.highlightCellModeISP(e);break;case'normal':this.highlightCellModeNormal(e,t.savingStatus)}},highlightCellModeISP:function(e){var t,r=e.children('input');t=r.length>0?parseInt(r.val()):parseInt(e.text());var a=e.attr('name');if(!window.pretendMarks||void 0===window.pretendMarks[a])return!0;var n=parseInt(pretendMarks[a]);if(isNaN(n)||isNaN(t))return!0;e.addClass(this.getISPHighlightClassByDif(t-n))},highlightCellModeNormal:function(e,t){-1!==['saved','notsave','saving'].indexOf(t)&&e.addClass(t)},getISPHighlightClassByDif:function(e){return e+=4,e=Math.max(e,1),'cell--target-'+(e=Math.min(e,5))}};